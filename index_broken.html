<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Survival Phrases</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --pol-red: #dc143c; --bg: #f5f5f5; --card: white; --tile-bg: #e8f4f8; --wrong-blue: #4a90e2; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #333; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 8px; display: flex; align-items: center; gap: 6px; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .header h1 { font-size: 1rem; font-weight: 800; flex-grow: 1; }
        #level-select { font-size: 0.7rem; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-weight: 600; background: var(--bg); color: #666; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; }
        #search-bar { font-size: 0.7rem; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; max-width: 180px; }

        #quiz-ui { padding: 8px; background: var(--card); border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        #progress-bar-bg { height: 4px; background: #ddd; border-radius: 2px; flex-grow: 1; overflow: hidden; }
        #progress-bar { height: 100%; background: var(--pol-red); width: 0%; transition: width 0.3s; }
        .speaker-btn { background: var(--bg); border: 1px solid #ddd; border-radius: 50%; width: 42px; height: 42px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .q-content { flex-grow: 1; text-align: center; min-width: 0; }
        .q-text { font-size: 1.1rem; font-weight: 800; word-wrap: break-word; }
        .feedback { height: 12px; font-size: 0.7rem; font-weight: bold; margin-top: 4px; }

        .mode-tabs { display: flex; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 8px; text-align: center; font-size: 0.7rem; font-weight: bold; cursor: pointer; opacity: 0.4; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--pol-red); color: var(--pol-red); }

        .map-section { flex-grow: 1; padding: 8px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; -webkit-overflow-scrolling: touch; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; max-width: 420px; }
        .tile { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; background: var(--tile-bg); border-radius: 8px; cursor: pointer; padding: 4px; text-align: center; font-size: 0.6rem; font-weight: 700; line-height: 1.1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; word-wrap: break-word; }
        .tile.wrong { background: var(--wrong-blue) !important; color: white !important; }

        .mastered-list { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 6px; }
        .banked-item { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 10px; border-radius: 8px; border: 1px solid #ddd; text-align: left; position: relative; cursor: pointer; }
        .banked-item strong { font-size: 0.85rem; }
        .banked-item small { font-size: 0.7rem; }
        .lvl-tag { font-size: 0.5rem; background: #eee; padding: 2px 4px; border-radius: 4px; position: absolute; right: 40px; top: 10px; color: #888; }

        .footer { padding: 8px 8px 24px 8px; display: flex; justify-content: center; gap: 6px; border-top: 1px solid #ddd; background: var(--card); flex-shrink: 0; }
        .footer-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.6rem; padding: 6px 8px; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1; text-align: center; }

        #save-toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 6px 12px; border-radius: 16px; font-size: 0.65rem; display: none; z-index: 1000; pointer-events: none; }
        
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #overlay h1 { font-size: 1.5rem; margin-bottom: 10px; }
        #overlay button { background: var(--pol-red); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="header">
    <h1>ðŸ‡µðŸ‡± Polish Survival</h1>
    <select id="level-select" onchange="changeLevel(this.value)"></select>
    <input id="search-bar" type="text" placeholder="Search..." oninput="filterBanked()">
</div>

<div id="quiz-ui">
    <button class="speaker-btn" id="speaker-btn">ðŸ”Š</button>
    <div class="q-content">
        <div id="q-text" class="q-text">Ready?</div>
        <div id="feedback" class="feedback"></div>
    </div>
</div>

<div class="mode-tabs">
    <div id="tab-learning" class="tab active" onclick="switchMode('learning')">PRACTICE</div>
    <div id="tab-mastered" class="tab" onclick="switchMode('mastered')">BANKED</div>
</div>

<div class="map-section">
    <div id="mastery-map"></div>
</div>

<div class="footer">
    <button class="footer-btn" onclick="downloadProgress()">Save File</button>
    <button class="footer-btn" onclick="uploadProgress()">Load File</button>
    <button class="footer-btn" onclick="if(confirm('Reset all progress?')) resetProgress()">Reset</button>
</div>

<div id="save-toast">Progress Saved</div>
<div id="overlay">
    <h1>ðŸŽ‰ Level Complete!</h1>
    <p style="margin-bottom:20px;">You've mastered all phrases in this level.</p>
    <button onclick="advanceLevel()">Next Level</button>
</div>

<input type="file" id="file-input" style="display:none" accept=".json">

<script>
    const THRESHOLD = 3;
    let plVoice = null;
    let currentLevel = 1;
    let phrasesData = [];
    let stats = {};
    let currentTarget = null;
    let wrongChoices = [];
    let lastTapTime = 0;
    let isSpeaking = false;

    function initSpeech() { 
        if(window.speechSynthesis) { 
            window.speechSynthesis.onvoiceschanged = () => { 
                const v = window.speechSynthesis.getVoices(); 
                plVoice = v.find(x=>x.lang.startsWith('pl')) || v[0]; 
            }; 
        } 
    }

    async function populateLevelSelect() { 
        const s = document.getElementById('level-select'); 
        for(let i=1; i<=20; i++) { 
            try {
                const r = await fetch(`phrases_${i}.json?t=${Date.now()}`); 
                const d = await r.json(); 
                const o = document.createElement('option'); 
                o.value = i; 
                o.textContent = `Level ${i}: ${d.description || 'Loading...'}`; 
                s.appendChild(o); 
            } catch(e) { 
                const o = document.createElement('option'); 
                o.value = i; 
                o.textContent = `Level ${i}`; 
                s.appendChild(o); 
            } 
        } 
        s.value = currentLevel; 
    }

    function loadStats() { 
        const s = localStorage.getItem('polishStats'); 
        stats = s ? JSON.parse(s) : {}; 
    }

    function saveStats() { 
        localStorage.setItem('polishStats', JSON.stringify(stats)); 
        localStorage.setItem('polishCurrentLevel', currentLevel); 
        updateStats(); 
        showToast(); 
    }

    function showToast() { 
        const t = document.getElementById('save-toast'); 
        t.style.display='block'; 
        setTimeout(()=>t.style.display='none', 1500); 
    }

    async function loadLevelData() { 
        try { 
            const r = await fetch(`phrases_${currentLevel}.json?t=${Date.now()}`); 
            const d = await r.json(); 
            phrasesData = d.phrases || []; 
            updateStats(); 
            updateMap(); 
            pickNewTarget(); 
        } catch(e) { 
            console.error(e); 
        } 
    }

    function pickNewTarget() { 
        const unmastered = phrasesData.filter(p=>(stats[p.pl]||0)<THRESHOLD); 
        if(!unmastered.length) { 
            document.getElementById('overlay').style.display='flex'; 
            return; 
        } 
        currentTarget = unmastered[Math.floor(Math.random()*unmastered.length)]; 
        wrongChoices = phrasesData.filter(p=>p.pl!==currentTarget.pl).sort(()=>Math.random()-0.5).slice(0,15); 
        document.getElementById('q-text').textContent = currentTarget.en; 
        document.getElementById('feedback').textContent = ''; 
    }

    function checkAnswer(chosen) { 
        const fb = document.getElementById('feedback'); 
        if(chosen === currentTarget.pl) { 
            fb.textContent = 'âœ… Correct!'; 
            fb.style.color = 'green'; 
            stats[currentTarget.pl] = (stats[currentTarget.pl]||0)+1; 
            saveStats(); 
            setTimeout(()=>{ pickNewTarget(); updateMap(); }, 600); 
        } else { 
            fb.textContent = 'âŒ Wrong! It was: '+currentTarget.pl; 
            fb.style.color = 'red'; 
            stats[currentTarget.pl] = Math.max(0, (stats[currentTarget.pl]||0)-1); 
            saveStats(); 
            setTimeout(()=>{ pickNewTarget(); updateMap(); }, 1200); 
        } 
    }

    function updateMap() { 
        const m = document.getElementById('mastery-map'); 
        const mode = document.querySelector('.tab.active').id.replace('tab-',''); 
        if(mode==='learning') { 
            const tiles = phrasesData.map(p=>{ 
                const mastered = (stats[p.pl]||0)>=THRESHOLD; 
                const cls = mastered ? 'tile' : 'tile wrong'; 
                return `<div class="${cls}" onclick="checkAnswer('${p.pl.replace(/'/g,"\\'")}')"><span>${p.pl}</span></div>`; 
            }).join(''); 
            m.innerHTML = `<div class="grid">${tiles}</div>`; 
        } else { 
            const mastered = phrasesData.filter(p=>(stats[p.pl]||0)>=THRESHOLD); 
            const searchTerm = document.getElementById('search-bar').value.toLowerCase(); 
            const filtered = searchTerm ? mastered.filter(p=>p.pl.toLowerCase().includes(searchTerm)||p.en.toLowerCase().includes(searchTerm)) : mastered; 
            const items = filtered.map(p=>`<div class="banked-item" onclick="speak('${p.pl.replace(/'/g,"\\'")}')"><div><strong>${p.pl}</strong><br><small>${p.en}</small></div><span class="lvl-tag">L${p.level}</span><span style="font-size:1.2rem;">ðŸ”Š</span></div>`).join(''); 
            m.innerHTML = `<div class="mastered-list">${items}</div>`; 
        } 
    }

    function filterBanked() { 
        updateMap(); 
    }

    function downloadProgress() { 
        const blob = new Blob([JSON.stringify({stats,currentLevel},null,2)], {type:'application/json'}); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = 'polish-progress.json'; 
        a.click(); 
    }

    function uploadProgress() { 
        const i = document.getElementById('file-input'); 
        i.onchange = (e) => { 
            const f = e.target.files[0]; 
            if(f) { 
                const r = new FileReader(); 
                r.onload = (ev) => { 
                    try { 
                        const d = JSON.parse(ev.target.result); 
                        stats = d.stats || {}; 
                        currentLevel = d.currentLevel || 1; 
                        saveStats(); 
                        document.getElementById('level-select').value = currentLevel; 
                        loadLevelData(); 
                        alert('Progress loaded!'); 
                    } catch(e) { 
                        alert('Invalid file!'); 
                    } 
                }; 
                r.readAsText(f); 
            } 
        }; 
        i.click(); 
    }

    function resetProgress() { 
        if(confirm('This will delete all your progress. Are you sure?')) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    }
    
    function updateStats() { 
        if(phrasesData.length) {
            document.getElementById('progress-bar').style.width = (phrasesData.filter(p=>(stats[p.pl]||0)>=THRESHOLD).length/phrasesData.length)*100+"%"; 
        }
    }
    
    function switchMode(m) { 
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
        document.getElementById('tab-'+m).classList.add('active'); 
        document.getElementById('quiz-ui').style.display = (m==='learning')?'flex':'none'; 
        document.getElementById('search-bar').value = ''; 
        updateMap(); 
    }
    
    function speak(t, rate = 1.0) { 
        if(isSpeaking) {
            window.speechSynthesis.cancel();
            isSpeaking = false;
            return;
        }
        
        const m = new SpeechSynthesisUtterance(t); 
        if(plVoice) m.voice=plVoice; 
        m.lang='pl-PL';
        m.rate = rate;
        
        m.onstart = () => { isSpeaking = true; };
        m.onend = () => { isSpeaking = false; };
        m.onerror = () => { isSpeaking = false; };
        
        window.speechSynthesis.speak(m); 
    }
    
    function changeLevel(v) { 
        currentLevel = parseInt(v); 
        saveStats(); 
        loadLevelData(); 
    }
    
    function speakTarget() { 
        if(!currentTarget) return;
        
        const now = Date.now();
        const timeSinceLastTap = now - lastTapTime;
        
        // Double tap detected (within 400ms)
        if(timeSinceLastTap < 400 && timeSinceLastTap > 0) {
            speak(currentTarget.pl, 0.5); // Half speed
            lastTapTime = 0; // Reset to prevent triple-tap
        } else {
            speak(currentTarget.pl, 1.0); // Normal speed
            lastTapTime = now;
        }
    }
    
    function advanceLevel() { 
        currentLevel++; 
        if(currentLevel > 20) currentLevel = 1; 
        document.getElementById('level-select').value = currentLevel;
        document.getElementById('overlay').style.display='none';
        changeLevel(currentLevel); 
    }

    // Setup speaker button with double-tap support
    document.getElementById('speaker-btn').addEventListener('click', speakTarget);

    window.onload = async () => { 
        initSpeech(); 
        await populateLevelSelect(); 
        loadStats(); 
        const savedLevel = localStorage.getItem('polishCurrentLevel'); 
        if(savedLevel) { 
            currentLevel = parseInt(savedLevel); 
            document.getElementById('level-select').value = currentLevel; 
        } 
        loadLevelData(); 
    };
</script>

</body>
</html>
