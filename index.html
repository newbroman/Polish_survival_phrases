<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Phrase Master v5.12</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="icon-192.png">
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW v2000 registered'))
                .catch(err => console.log('SW failed', err));
        });
    }
</script>

    <style>
        :root { --pol-red: #dc143c; --wrong-blue: #3498db; --bg: #f0f2f5; --card: #ffffff; --text: #333; --tile-bg: #dee2e6; --success-green: #2ecc71; --gold: #ffd700; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --tile-bg: #404040; } }
        
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; color: var(--text); }
        
        .header { width: 100%; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; position: relative;}
        .title-banner { 
            background: linear-gradient(to bottom, #ffffff 50%, #dc143c 50%); 
            padding: 8px 0; border-bottom: 1px solid #ccc; 
        }
        .title { font-weight: 800; font-size: 1rem; color: #333; text-align: center; margin: 0; }
        
        .controls-row { width: 90%; max-width: 400px; margin: 0 auto; padding: 6px 0; display: flex; flex-direction: column; gap: 6px; }
        
        .search-row { display: flex; gap: 6px; width: 100%; }
        
        .search-box { 
            flex: 1; background: var(--bg); border: 1px solid #ccc; color: var(--text); 
            padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; 
            height: 28px; outline: none; box-sizing: border-box;
        }

        .help-btn-inline {
            width: 28px; height: 28px; border-radius: 4px; 
            background: var(--bg); border: 1px solid #ccc; 
            font-weight: 900; font-size: 0.9rem; cursor: pointer; color: var(--pol-red);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .gender-dropdown-wrapper { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 80px; }
        .gender-dropdown { position: relative; flex: 1; }
        .gender-dropdown-trigger { 
            width: 100%; background: var(--bg); border: 1px solid #ccc; color: var(--text); 
            padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; 
            text-align: center; height: 28px; display: flex; align-items: center; 
            justify-content: center; gap: 5px; cursor: pointer; box-sizing: border-box;
        }
        .gender-dropdown-trigger::after { content: '‚ñº'; font-size: 7px; color: #888; }
        .gender-dropdown-menu { 
            position: absolute; top: 100%; left: 0; right: 0; background: var(--card); 
            border: 1px solid #ccc; border-radius: 4px; z-index: 1000; display: none; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .gender-dropdown-menu.show { display: block; }
        
        .dropdown-item { 
            padding: 8px 10px; font-size: 10px; border-bottom: 1px solid #eee; 
            cursor: pointer; color: var(--text); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .dropdown-item.mastered { color: var(--text); }
        .check-icon { font-size: 12px; margin-left: 5px; }

        .progress-wrapper { position: relative; width: 100%; }
        .progress-container { width: 100%; height: 3px; background: #ddd; }
        #progress-bar { width: 0%; height: 100%; background: var(--pol-red); transition: width 0.3s; }
        .progress-pulse { animation: bar-flash 0.5s ease-out; }
        @keyframes bar-flash {
            0% { background-color: var(--pol-red); }
            50% { background-color: #fff; box-shadow: 0 0 10px #fff; }
            100% { background-color: var(--pol-red); }
        }

        .quiz-header { background: var(--card); padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; flex-shrink: 0; transition: transform 0.1s; }
        .quiz-top-row { display: flex; align-items: center; gap: 12px; width: 90%; max-width: 400px; margin: 0 auto; justify-content: flex-start; }
        .speaker-btn { background: var(--bg); border: 1px solid #ddd; border-radius: 50%; width: 42px; height: 42px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; user-select: none; }
        .q-content { text-align: left; min-width: 0; }
        .q-text { font-size: 1.1rem; font-weight: 800; }
        .feedback { height: 12px; font-size: 0.7rem; font-weight: bold; margin-top: 4px; }

        .mode-tabs { display: flex; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 0.75rem; font-weight: bold; cursor: pointer; opacity: 0.4; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--pol-red); color: var(--pol-red); }

        .map-section { flex-grow: 1; padding: 10px 8px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box; transition: transform 0.1s; }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 6px; 
            width: 100%; 
            max-width: 360px; 
            margin: 0 auto;
        }
        
        .tile { 
            min-height: 70px;
            display: flex; align-items: center; justify-content: center; 
            background: var(--tile-bg); border-radius: 6px; cursor: pointer; padding: 4px; 
            text-align: center; 
            font-size: 0.75rem; 
            font-weight: 700; line-height: 1.2; 
            box-shadow: 0 2px 0px rgba(0,0,0,0.15); 
            transition: background 0.2s, transform 0.1s, box-shadow 0.1s; 
            position: relative;
            border: 2px solid transparent; 
            word-wrap: break-word; overflow: hidden;
        }

        .grid.lvl0 { 
            grid-template-columns: repeat(5, 1fr); 
            max-width: 380px; 
        }
        .grid.lvl0 .tile {
            aspect-ratio: 1/1; 
            min-height: auto;
            font-size: 0.9rem;
        }

        .tile:active { transform: translateY(2px); box-shadow: 0 0 0 rgba(0,0,0,0.15); }
        .tile.wrong { background: var(--wrong-blue) !important; color: white !important; }
        .tile.mastered-border { border-color: var(--gold); box-shadow: 0 0 5px rgba(255, 215, 0, 0.4); }
        
        @keyframes gold-pop-anim {
            0% { transform: scale(1); background-color: var(--gold); }
            50% { transform: scale(1.2); box-shadow: 0 0 15px var(--gold); }
            100% { transform: scale(1); background-color: var(--tile-bg); }
        }
        .tile.gold-pop { animation: gold-pop-anim 0.6s ease-out; z-index: 10; }

        #search-results-list {
            width: 100%; max-width: 400px;
            display: none;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 20px;
        }
        .global-result-item {
            background: var(--card); border: 1px solid #ccc;
            border-left: 4px solid var(--pol-red);
            border-radius: 6px; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .global-result-item:active { transform: scale(0.98); }
        .copy-btn-search {
            background: #eee; border: 1px solid #ccc; border-radius: 4px;
            padding: 4px 8px; font-size: 0.7rem; cursor: pointer; margin-left: 8px;
        }
        .copy-btn-search:active { background: #ddd; }

        .lvl0-content { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; }
        .lvl0-big { font-size: 1.2rem; font-weight: 800; color: var(--pol-red); }
        .lvl0-sub { font-size: 0.65rem; color: #666; margin-top: -2px; }
        .lvl0-emoji { font-size: 1.1rem; margin-top: 2px; }

        .footer { padding: 8px 8px 24px 8px; display: flex; justify-content: center; gap: 6px; border-top: 1px solid #ddd; background: var(--card); flex-shrink: 0; }
        .footer-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.6rem; padding: 6px; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1; text-align: center; }
        .active-swap { background: var(--pol-red) !important; color: white !important; border-color: var(--pol-red) !important; }
        .hard-mode-active { background: #333 !important; color: #fff !important; border-color: #333 !important; }

        .ui-toggle-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.6rem; padding: 0 8px; border-radius: 6px; cursor: pointer; font-weight: 400; height: 28px; white-space: nowrap; max-width: 100px; }
        .swap-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.6rem; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: 800; min-width: 40px; }
        .swap-btn.active { background: #4a9eff; color: white; border-color: #4a9eff; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: white; }
        .review-notice { background: var(--card); padding: 20px; border-radius: 12px; border: 2px dashed var(--pol-red); text-align: center; max-width: 300px; }

        #hf-overlay { position: fixed; inset: 0; background: #0a0a0a; z-index: 3000; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-family: -apple-system, sans-serif; }
        .hf-header { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .hf-close { background: transparent; color: #888; font-size: 2rem; border: none; cursor: pointer; padding: 10px; line-height: 1; }
        .hf-progress-bar { position: absolute; top: 0; left: 0; height: 4px; background: #dc143c; width: 0%; transition: width 0.3s; }
        .hf-content-area { flex: 1; display: flex; flex-direction: column; justify-content: center; width: 90%; max-width: 500px; }
        .hf-big-text { font-size: 2rem; font-weight: 800; margin-bottom: 1rem; color: #dc143c; line-height: 1.2; }
        .hf-sub-text { font-size: 1.3rem; color: #bbb; margin-bottom: 1rem; font-weight: 400; }
        .hf-meta { font-size: 0.8rem; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .hf-controls { display: flex; gap: 20px; margin-bottom: 40px; justify-content: center; width: 100%; }
        .hf-btn { padding: 15px 30px; border-radius: 50px; border: 2px solid #333; font-size: 1rem; font-weight: bold; cursor: pointer; background: #222; color: white; transition: all 0.2s; min-width: 120px; }
        .hf-btn:active { transform: scale(0.95); }
        .hf-btn.primary { background: #dc143c; border-color: #dc143c; }
        .hf-celebration { display: none; flex-direction: column; align-items: center; gap: 20px; }
        .hf-countdown-circle { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #dc143c; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
        .pause-selector { display: flex; gap: 5px; align-items: center; margin-top: 10px; justify-content: center; color: #666; font-size: 0.8rem; }
        .pause-option { padding: 4px 10px; border: 1px solid #333; background: #111; border-radius: 4px; cursor: pointer; }
        .pause-option.active { background: #dc143c; color: white; border-color: #dc143c; }

        #help-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; 
            display: none; align-items: center; justify-content: center; 
        }
        .help-modal { 
            background: var(--card); color: var(--text); padding: 25px; 
            border-radius: 12px; max-width: 90%; width: 400px; 
            max-height: 80vh; overflow-y: auto; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); font-size: 0.9rem;
        }
        .help-close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; border: none; background: none; color: #666; cursor: pointer; }
        .help-h2 { color: var(--pol-red); font-weight: 800; margin-top: 0; margin-bottom: 15px; text-align: center; }
        .help-sec { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .help-sec:last-child { border-bottom: none; }

        .custom-dropdown { position: relative; width: 100%; }
        .dropdown-trigger { width: 100%; background: var(--bg); border: 1px solid #ccc; color: var(--text); padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; text-align: left; height: 28px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; box-sizing: border-box; }
        .dropdown-trigger::after { content: '‚ñº'; font-size: 7px; color: #888; }
        .dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid #ccc; border-radius: 4px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .dropdown-menu.show { display: block; }
</style>
</head>
<body>

<div id="overlay">
    <h1></h1>
    <button onclick="advanceLevel()" style="padding: 12px 24px; background: var(--pol-red); color: white; border: none; border-radius: 8px; font-weight: bold;"></button>
</div>

<div id="help-overlay">
    <div class="help-modal">
        <button class="help-close" onclick="toggleHelp()">√ó</button>
        <h2 class="help-h2">How to Play</h2>
        <div class="help-sec">
            <div style="font-weight:bold; margin-bottom:5px;">üéØ The Goal</div>
            Turn all tiles <span style="color:var(--gold); font-weight:900; -webkit-text-stroke: 0.5px #333;">GOLD</span>. <br>
            Answer correctly <b>3 times</b> to master a phrase and move it to your Bank.
        </div>
        <div class="help-sec">
            <div style="font-weight:bold; margin-bottom:5px;">üéÆ Controls</div>
            <ul>
                <li><b>Tap a Tile:</b> Check your answer.</li>
                <li><b>SWAP:</b> Switch between seeing Polish or English text.</li>
                <li><b>üß† Hard Mode:</b> Hides the text! Audio only.</li>
                <li><b>üéß Hands-Free:</b> Auto-play mode for passive listening.</li>
            </ul>
        </div>
        <div class="help-sec">
            <div style="font-weight:bold; margin-bottom:5px;">üíæ Saving</div>
            Your progress saves automatically to this device. Use the <b>Save</b> button below to download a backup file.
        </div>
        <div style="text-align:center; font-size:0.75rem; color:#888;">Polish Phrase Master v5.12</div>
    </div>
</div>

<div id="hf-overlay">
    <div class="hf-progress-bar" id="hf-bar"></div>
    <div class="hf-header">
        <div style="font-size:0.8rem; color:#666;" id="hf-level-indicator">Level 1.0</div>
        <button class="hf-close" onclick="closeHandsFree()">√ó</button>
    </div>

    <div class="hf-content-area" id="hf-active-view">
        <div class="hf-meta" id="hf-counter">1 / 20</div>
        <div class="hf-big-text" id="hf-pl">Ready...</div>
        <div class="hf-sub-text" id="hf-en">Get set...</div>
        
        <div class="pause-selector">
            <span>Pause:</span>
            <div class="pause-option" onclick="setPauseDuration(1)">1s</div>
            <div class="pause-option active" onclick="setPauseDuration(3)">3s</div>
            <div class="pause-option" onclick="setPauseDuration(5)">5s</div>
        </div>
    </div>

    <div class="hf-content-area hf-celebration" id="hf-done-view">
        <h2 style="color: #dc143c;">Level Complete!</h2>
        <div class="hf-countdown-circle" id="hf-timer-val">10</div>
        <p style="color: #888; font-size: 0.9rem;">Auto-advancing...</p>
    </div>

    <div class="hf-controls" id="hf-controls-active">
        <button class="hf-btn" id="hf-pp-btn" onclick="togglePlayPauseHF()">‚è∏ Pause</button>
        <button class="hf-btn" onclick="skipPhraseHF()">Next ‚è≠</button>
    </div>

    <div class="hf-controls" id="hf-controls-done" style="display:none;">
        <button class="hf-btn" onclick="restartLevelHF()">‚Ü∫ Restart</button>
        <button class="hf-btn primary" onclick="forceNextLevelHF()">Next Level ‚è≠</button>
    </div>
</div>

<div class="header">
    <div class="title-banner">
        <h1 class="title">Say some Polish phrases</h1>
    </div>
    <div class="controls-row">
        <div class="custom-dropdown">
            <div class="dropdown-trigger" id="lvl-current" onclick="toggleDropdown(event)">Loading levels...</div>
            <div class="dropdown-menu" id="lvl-menu"></div>
        </div>
        
        <div class="search-row">
            <input type="text" id="search-bar" class="search-box" placeholder="Search..." oninput="handleSmartSearch()">
            <button class="help-btn-inline" onclick="toggleHelp()">?</button>
        </div>
        
        <div style="display: flex; gap: 6px; align-items: center; width: 100%;">
            <div class="gender-dropdown-wrapper">
                <div class="gender-dropdown">
                    <div class="gender-dropdown-trigger" id="gender-current" onclick="toggleGenderDropdown(event)">Both</div>
                    <div class="gender-dropdown-menu" id="gender-menu">
                        <div class="gender-dropdown-item" onclick="selectGender('m')">Male</div>
                        <div class="gender-dropdown-item" onclick="selectGender('f')">Female</div>
                        <div class="gender-dropdown-item" onclick="selectGender('both')">Both</div>
                    </div>
                </div>
            </div>
            <button id="ui-lang-btn" class="ui-toggle-btn" onclick="toggleUILang()"><b>EN</b>/PL</button>
            <button id="hard-mode-btn" class="footer-btn" style="height: 28px; padding: 0 8px; font-size: 0.6rem; flex: 0 0 auto; white-space: nowrap; max-width: 100px;" onclick="toggleHardMode()">üß† Hard Mode</button>
            <button id="hf-btn" class="footer-btn" style="height: 28px; padding: 0 8px; font-size: 0.6rem; flex: 0 0 auto; white-space: nowrap; max-width: 110px; background:var(--pol-red); color:white; border-color:var(--pol-red);" onclick="openHandsFree()">üéß Hands-Free</button>
        </div>
    </div>
</div>

<div class="progress-wrapper">
    <div class="progress-container"><div id="progress-bar"></div></div>
</div>

<div class="quiz-header" id="quiz-ui">
    <div class="quiz-top-row">
        <button class="swap-btn" onclick="toggleContentSwap()">SWAP</button>
        <div class="speaker-btn" onclick="handleSpeakerTap()">üîä</div>
        <div class="q-content">
            <div id="q-text" class="q-text">Ready?</div>
            <div id="feedback" class="feedback"></div>
        </div>
    </div>
</div>

<div class="mode-tabs">
    <div id="tab-learning" class="tab active" onclick="switchMode('learning')">PRACTICE <span id="learning-count"></span></div>
    <div id="tab-mastered" class="tab" onclick="switchMode('mastered')">BANKED <span id="banked-count"></span></div>
</div>

<div class="map-section" id="game-area">
    <div id="mastery-map" class="grid"></div>
    <div id="search-results-list"></div> </div>

<div class="footer">
    <button id="btn-save" class="footer-btn" onclick="downloadProgress()">Save</button>
    <button id="btn-load" class="footer-btn" onclick="document.getElementById('file-input').click()">Load</button>
    <button id="btn-clear" class="footer-btn" onclick="resetEverything()" style="color: #e74c3c;">Clear</button>
    <input type="file" id="file-input" style="display:none" onchange="importProgress(event)">
</div>

<script>
    let stats = JSON.parse(localStorage.getItem('pl_mastery_final')) || {};
    let currentLevel = localStorage.getItem('pl_current_level_idx') || "0"; 
    let phrasesData = [], activePool = [], allPhrasesCache = [], currentTarget = null;
    let levelList = []; 
    let recentPhrasesQueue = []; 
    let isSwapped = false;
    let currentGender = localStorage.getItem('polishMasterGender') || 'both';
    let uiLang = localStorage.getItem('polishMasterUILang') || 'en'; 
    let hardMode = false; 
    let correctStreak = 0; 
    const THRESHOLD = 3;
    const MIN_SCORE = -2;
    let plVoice = null;
    let audioCtx = null;
    let audioKeepAliveInterval = null;

    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function enableAudioKeepAlive() {
        if (audioKeepAliveInterval) return;
        if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }
        audioKeepAliveInterval = setInterval(() => {
            if (audioCtx) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                try {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    gain.gain.value = 0.001;
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.01);
                } catch(e) {}
            }
        }, 20000);
    }

    function playNote(freq, dur, type='sine') {
        initAudioContext(); enableAudioKeepAlive();
        if (audioCtx.state === 'suspended') { audioCtx.resume().then(() => playTone(freq, dur, type)); } else { playTone(freq, dur, type); }
    }
    
    function playTone(freq, dur, type='sine') {
        try {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, now);
            g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(now + dur);
        } catch(e) {}
    }

    function playWrongSlide() {
        try {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(40, now + 0.4);
            g.gain.setValueAtTime(0.2, now);
            g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(now + 0.4);
        } catch(e) {}
    }

    function playCorrect() { 
        const freq = Math.min(220 + (correctStreak * 15), 880);
        playNote(freq, 0.15, 'sine'); 
    }

    function playBanked() {
        setTimeout(() => playNote(523.25, 0.1, 'sine'), 0);
        setTimeout(() => playNote(659.25, 0.1, 'sine'), 80);
        setTimeout(() => playNote(783.99, 0.2, 'sine'), 160);
    }

    function playSuccess() { 
        playNote(523, 0.2, 'triangle'); 
        setTimeout(() => playNote(659, 0.2, 'triangle'), 100); 
        setTimeout(() => playNote(783, 0.4, 'triangle'), 200); 
    }
    
    function initSpeech() { plVoice = window.speechSynthesis.getVoices().find(v => v.lang.startsWith('pl')); }

    const translations = {
        en: { 
            title: "Say some Polish phrases", search: "Search...", phraseGender: "Phrase Gender:", 
            male: "Male", female: "Female", both: "Both", correct: "Correct! üåü", mistake: "Mistake!", 
            levelMastered: "LEVEL MASTERED! üèÜ", nextLevel: "Next Level", masteredTitle: "Level Mastered!", 
            masteredText: "You finished this set.", repeatLevel: "Repeat Level", foundInOther: "FOUND IN OTHER LEVELS:", 
            loading: "Loading levels...", hardMode: "üß† Hard Mode", handsFree: "üéß Hands-Free", 
            practice: "PRACTICE", banked: "BANKED", save: "Save", load: "Load", clear: "Clear", ready: "Ready?"
        },
        pl: { 
            title: "Powiedz polskie zwroty", search: "Szukaj...", phraseGender: "Rodzaj zwrotu:", 
            male: "Mƒô≈ºczyzna", female: "Kobieta", both: "Oboje", correct: "Dobrze! üåü", mistake: "B≈ÇƒÖd!", 
            levelMastered: "POZIOM OPANOWANY! üèÜ", nextLevel: "Nastƒôpny poziom", masteredTitle: "Poziom opanowany!", 
            masteredText: "Uko≈Ñczy≈Çe≈õ tƒô kategoriƒô.", repeatLevel: "Powt√≥rz poziom", foundInOther: "ZNALEZIONO W INNYCH POZIOMACH:", 
            loading: "≈Åadowanie...", hardMode: "üß† Trudny", handsFree: "üéß Bez RƒÖk", 
            practice: "TRENING", banked: "OPANOWANE", save: "Zapisz", load: "Wczytaj", clear: "Wyczy≈õƒá", ready: "Gotowy?"
        }
    };
    
    function t(key) { return translations[uiLang][key] || translations.en[key] || key; }
    
    function updateUILanguage() {
        const btn = document.getElementById('ui-lang-btn');
        if (uiLang === 'en') btn.innerHTML = "<b>EN</b>/PL";
        else btn.innerHTML = "EN/<b>PL</b>";
        document.querySelector('.title').innerText = t('title');
        document.getElementById('search-bar').placeholder = t('search');
        document.getElementById('hard-mode-btn').innerText = t('hardMode');
        document.getElementById('hf-btn').innerText = t('handsFree');
        
        const pCount = document.getElementById('learning-count').innerText;
        const bCount = document.getElementById('banked-count').innerText;
        const pNum = pCount.replace(/[^\d()]/g, '');
        const bNum = bCount.replace(/[^\d()]/g, '');

        document.getElementById('tab-learning').innerHTML = `${t('practice')} <span id="learning-count">${pNum}</span>`;
        document.getElementById('tab-mastered').innerHTML = `${t('banked')} <span id="banked-count">${bNum}</span>`;
        document.getElementById('btn-save').innerText = t('save');
        document.getElementById('btn-load').innerText = t('load');
        document.getElementById('btn-clear').innerText = t('clear');

        const genderItems = document.querySelectorAll('.gender-dropdown-item');
        if(genderItems.length > 0) {
            genderItems[0].innerText = t('male'); genderItems[1].innerText = t('female'); genderItems[2].innerText = t('both');
        }
        const genderMap = { m: t('male'), f: t('female'), both: t('both') };
        document.getElementById('gender-current').innerText = genderMap[currentGender];
        const overlay = document.getElementById('overlay');
        overlay.querySelector('h1').innerText = t('levelMastered');
        overlay.querySelector('button').innerText = t('nextLevel');
        if (!currentTarget && document.getElementById('q-text').innerText.includes('?')) {
             document.getElementById('q-text').innerText = t('ready');
        }
    }
    
    function toggleUILang() {
        uiLang = uiLang === 'en' ? 'pl' : 'en'; 
        localStorage.setItem('polishMasterUILang', uiLang); 
        updateUILanguage(); 
    }

    function toggleContentSwap() {
        isSwapped = !isSwapped;
        updateMap();
        if(currentTarget) updateQuestionText();
    }

    function toggleHardMode() {
        hardMode = !hardMode;
        document.getElementById('hard-mode-btn').classList.toggle('hard-mode-active');
        updateQuestionText();
    }

    function updateQuestionText() {
        if (!currentTarget) return;
        if (hardMode) {
            document.getElementById('q-text').innerText = "üëÇ Listen...";
        } else {
            document.getElementById('q-text').innerText = isSwapped ? currentTarget.pl : currentTarget.en;
        }
    }

    function getGenderText(phrase) {
        if (!phrase.gender || phrase.gender !== 'both' || !phrase.variants) return phrase.pl;
        if (currentGender === 'm') return phrase.variants.m;
        else if (currentGender === 'f') return phrase.variants.f;
        else return phrase.pl;
    }

    window.speechSynthesis.onvoiceschanged = initSpeech;
    function toggleGenderDropdown(e) { e.stopPropagation(); document.getElementById('gender-menu').classList.toggle('show'); }
    function selectGender(gender) {
        currentGender = gender; localStorage.setItem('polishMasterGender', gender);
        const genderLabels = { m: 'Male', f: 'Female', both: 'Both' };
        document.getElementById('gender-current').innerText = genderLabels[gender];
        document.getElementById('gender-menu').classList.remove('show');
        refreshActivePool(); updateMap(); startNewRound();
    }

    function refreshActivePool() {
        if (currentLevel === "0") {
            activePool = phrasesData;
        } else {
            if (currentGender !== 'both') {
                activePool = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD && (!p.gender || p.gender === currentGender || p.gender === 'both')).slice(0, 12);
            } else {
                activePool = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD).slice(0, 12);
            }
        }
    }

    function toggleDropdown(e) { e.stopPropagation(); document.getElementById('lvl-menu').classList.toggle('show'); }

    async function populateDropdown() {
        const menu = document.getElementById('lvl-menu'); menu.innerHTML = ''; levelList = [];
        let consecutiveEmptyMajors = 0; const MAX_CONSECUTIVE_EMPTY = 5;
        for (let major = 0; major <= 100; major++) {
            let foundInThisMajor = false;
            const promises = [];
            for (let minor = 0; minor <= 9; minor++) {
                const lvlId = minor === 0 && major === 0 ? "0" : (minor === 0 ? `${major}` : `${major}.${minor}`);
                promises.push(fetch(`phrases_${lvlId}.json`).then(r => r.ok ? r.json().then(d => ({id: lvlId, data: d, exists: true})) : {exists: false}).catch(() => ({exists: false})));
            }
            const results = await Promise.all(promises);
            for (const res of results) {
                if (res.exists) {
                    foundInThisMajor = true;
                    // Count progress
                    const totalCount = res.data.phrases.length;
                    const masteredCount = res.data.phrases.filter(p => (stats[p.pl] || 0) >= THRESHOLD).length;
                    
                    const isDone = masteredCount === totalCount;
                    let displayLabel = res.data.description || `Level ${res.id}`;
                    if (!displayLabel.startsWith(res.id)) displayLabel = `Lvl ${res.id}: ${displayLabel}`;
                    const levelObj = { id: res.id, description: displayLabel, isDone: isDone };
                    levelList.push(levelObj);
                    
                    const item = document.createElement('div');
                    item.className = 'dropdown-item' + (isDone ? ' mastered' : '');
                    // Add Progress Fraction
                    item.innerHTML = `<span>${displayLabel} <b>(${masteredCount}/${totalCount})</b></span>${isDone ? '<span class="check-icon">‚úÖ</span>' : ''}`;
                    item.onclick = (e) => { e.stopPropagation(); selectLevel(levelObj.id); };
                    menu.appendChild(item);
                    if(res.id == currentLevel) document.getElementById('lvl-current').innerText = displayLabel;
                }
            }
            if (foundInThisMajor) consecutiveEmptyMajors = 0; else consecutiveEmptyMajors++;
            if (consecutiveEmptyMajors >= MAX_CONSECUTIVE_EMPTY) break;
        }
    }

    function selectLevel(lvl) {
        currentLevel = lvl.toString();
        document.getElementById('lvl-menu').classList.remove('show');
        document.getElementById('search-bar').value = '';
        
        document.getElementById('mastery-map').style.display = 'grid';
        document.getElementById('search-results-list').style.display = 'none';
        
        saveStats(); 
        recentPhrasesQueue = [];
        loadLevelData();
    }

    async function loadLevelData() {
        try {
            const resp = await fetch(`phrases_${currentLevel}.json?v=${Date.now()}`);
            const data = await resp.json();
            phrasesData = data.phrases;
            let label = data.description || `Level ${currentLevel}`;
            if (!label.startsWith(currentLevel)) label = `Lvl ${currentLevel}: ${label}`;
            document.getElementById('lvl-current').innerText = label;
            refreshActivePool(); updateStats(); updateTabCounts(); updateMap(); startNewRound(); populateDropdown();
            cacheAllPhrases();
        } catch (err) { document.getElementById('q-text').innerText = "File not found"; }
    }

    async function cacheAllPhrases() {
        if (allPhrasesCache.length > 0) return;
        allPhrasesCache = [];
        const possibleLevels = [];
        for(let i=0; i<=30; i++) possibleLevels.push(i.toString()); 
        
        const promises = possibleLevels.map(lvl => 
            fetch(`phrases_${lvl}.json`).then(r => r.ok ? r.json() : null).then(d => {
                if(d) return d.phrases.map(p => ({...p, lvl: lvl}));
                return [];
            })
        );
        const results = await Promise.all(promises);
        results.forEach(r => allPhrasesCache.push(...r));
    }

    function copyToClipboard(text, event) {
        if(event) event.stopPropagation();
        navigator.clipboard.writeText(text).then(() => {
            alert("Copied: " + text);
        });
    }

    function handleSmartSearch() {
        const query = document.getElementById('search-bar').value.toLowerCase();
        const mapArea = document.getElementById('mastery-map');
        const listArea = document.getElementById('search-results-list');
        
        listArea.innerHTML = ''; 

        if (!query) { 
            mapArea.style.display = (currentLevel === "0") ? 'grid' : 'grid'; 
            listArea.style.display = 'none';
            updateMap(); 
            return; 
        }

        mapArea.style.display = 'none';
        listArea.style.display = 'flex';

        const matches = allPhrasesCache.filter(p => (p.pl.toLowerCase().includes(query) || p.en.toLowerCase().includes(query))).slice(0, 15);

        if (matches.length > 0) {
            matches.forEach(p => {
                const item = document.createElement('div'); 
                item.className = 'global-result-item';
                // Add Copy Button
                item.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:0.9rem;">${p.pl}</div>
                        <div style="color:#666; font-size:0.8rem;">${p.en}</div>
                    </div>
                    <div style="text-align:right; display:flex; align-items:center; gap:8px;">
                        <span style="font-size:0.7rem; font-weight:bold; color:var(--pol-red); border:1px solid var(--pol-red); padding:2px 4px; border-radius:4px;">LVL ${p.lvl}</span>
                        <button class="copy-btn-search" onclick="copyToClipboard('${p.pl.replace(/'/g, "\\'")}', event)">üìã</button>
                    </div>
                `;
                item.onclick = () => { selectLevel(p.lvl); };
                listArea.appendChild(item);
            });
        } else {
             const noRes = document.createElement('div');
             noRes.style.padding = "20px";
             noRes.style.textAlign = "center";
             noRes.style.color = "#888";
             noRes.innerText = "No matches found.";
             listArea.appendChild(noRes);
        }
    }

    function startNewRound() {
        if (!activePool.length) return;
        const historyLimit = Math.min(3, activePool.length - 1);
        let nextTarget;
        if (activePool.length === 1) {
            nextTarget = activePool[0];
        } else {
            do {
                nextTarget = activePool[Math.floor(Math.random() * activePool.length)];
            } while (
                historyLimit > 0 && recentPhrasesQueue.slice(-historyLimit).includes(nextTarget.pl)
            );
        }

        currentTarget = nextTarget;
        recentPhrasesQueue.push(currentTarget.pl);
        if (recentPhrasesQueue.length > 3) recentPhrasesQueue.shift();

        updateQuestionText();
        document.getElementById('feedback').innerText = "";
        
        setTimeout(() => {
            if (currentLevel === "0") {
                speak(currentTarget.pl + " jak " + currentTarget.word);
            } else {
                speak(currentTarget.pl);
            }
        }, 300);
    }

    function triggerProgressFlash() {
        const bar = document.getElementById('progress-bar');
        bar.classList.remove('progress-pulse');
        void bar.offsetWidth; 
        bar.classList.add('progress-pulse');
    }

    function checkAnswer(phrase, el) {
        initAudioContext(); enableAudioKeepAlive();

        if (phrase.pl === currentTarget.pl) {
            correctStreak++;
            stats[phrase.pl] = (stats[phrase.pl] || 0) + 1;
            
            triggerProgressFlash(); 

            if (stats[phrase.pl] >= THRESHOLD) {
                playBanked();
                el.classList.add('gold-pop'); 
            } else {
                playCorrect();
            }

            document.getElementById('feedback').innerText = t('correct'); saveStats();
            
            if (currentLevel === "0") {
               speak(phrase.pl + " jak " + phrase.word);
            }

            setTimeout(() => {
                if (stats[phrase.pl] >= THRESHOLD) {
                    const nextAvailable = phrasesData.find(p => (stats[p.pl] || 0) < THRESHOLD && !activePool.some(ap => ap.pl === p.pl));
                    const index = activePool.indexOf(phrase);
                    if (nextAvailable) activePool[index] = nextAvailable; else activePool.splice(index, 1);
                }
                updateStats(); updateTabCounts(); updateMap();
                if (activePool.length === 0) { document.getElementById('overlay').style.display='flex'; playSuccess(); correctStreak = 0; } else startNewRound();
            }, 1000); 
        } else {
            correctStreak = 0; 
            playWrongSlide(); 
            
            let currentScore = stats[currentTarget.pl] || 0; stats[currentTarget.pl] = Math.max(MIN_SCORE, currentScore - 1);
            el.classList.add('wrong'); document.getElementById('feedback').innerText = t('mistake'); saveStats(); 
            setTimeout(() => { el.classList.remove('wrong'); updateMap(); startNewRound(); }, 1200);
        }
    }

    function updateMap(filter = "") {
        const area = document.getElementById('mastery-map'); area.innerHTML = '';
        const isLearning = document.getElementById('tab-learning').classList.contains('active');
        
        if (isLearning && activePool.length === 0 && !filter) {
            const notice = document.createElement('div'); notice.className = 'review-notice';
            notice.innerHTML = `<h3>${t("masteredTitle")}</h3><p>${t("masteredText")}</p><button onclick="resetLevelMastery()" style="padding:10px 20px; background:var(--pol-red); color:white; border:none; border-radius:6px; font-weight:bold;">${t("repeatLevel")}</button>`;
            area.appendChild(notice); return;
        }

        if (currentLevel === "0") {
            area.className = "grid lvl0"; 
        } else {
            area.className = "grid"; 
        }

        const list = isLearning ? activePool : phrasesData.filter(p => (stats[p.pl]||0) >= THRESHOLD);
        list.filter(p => !filter || p.pl.toLowerCase().includes(filter) || p.en.toLowerCase().includes(filter)).forEach(p => {
            const tile = document.createElement('div'); tile.className = 'tile';
            
            if (currentLevel === "0") {
                tile.innerHTML = `
                    <div class="lvl0-content">
                        <div class="lvl0-big">${p.pl}</div>
                        <div class="lvl0-sub">${p.en}</div>
                        <div class="lvl0-emoji">${p.e || ''}</div>
                    </div>
                `;
            } else {
                tile.innerText = isSwapped ? p.en : getGenderText(p);
            }

            const score = stats[p.pl] || 0;
            if (score === -1) { tile.style.backgroundColor = "#ADD8E6"; tile.style.color = "#333"; }
            else if (score <= -2) { tile.style.backgroundColor = "#00008B"; tile.style.color = "white"; }
            else if (score > 0) {
                if (score >= THRESHOLD) {
                    // Mastered: Softer look (White background + Dark Text + Gold Border)
                    tile.style.backgroundColor = "var(--card)"; 
                    tile.style.color = "var(--text)";
                    tile.classList.add('mastered-border');
                } else {
                    // In Progress: Red Gradient
                    const opacity = score / THRESHOLD;
                    tile.style.backgroundColor = `rgba(220, 20, 60, ${opacity})`;
                    if (opacity > 0.6) tile.style.color = "white";
                }
            }
            
            tile.onclick = () => {
                if (isLearning) {
                    checkAnswer(p, tile);
                } else {
                    if (currentLevel === "0") speak(p.pl + " jak " + p.word);
                    else speak(p.pl);
                }
            };
            area.appendChild(tile);
        });
    }

    function speak(t, rate = 1.0, lang = 'pl-PL') {
        initAudioContext(); enableAudioKeepAlive();
        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        window.speechSynthesis.cancel(); 
        const m = new SpeechSynthesisUtterance(t); 
        if(lang === 'pl-PL' && plVoice) m.voice=plVoice; 
        m.lang=lang; m.rate = rate; window.speechSynthesis.speak(m); 
    }

    function saveStats() { localStorage.setItem('pl_mastery_final', JSON.stringify(stats)); localStorage.setItem('pl_current_level_idx', currentLevel); }
    function updateStats() { if(phrasesData.length) { const m = phrasesData.filter(p=>(stats[p.pl]||0)>=THRESHOLD).length; document.getElementById('progress-bar').style.width = (m/phrasesData.length)*100+"%"; } }
    
    function advanceLevel() { 
        const currentIdx = levelList.findIndex(l => l.id == currentLevel);
        if (currentIdx !== -1 && currentIdx < levelList.length - 1) {
            document.getElementById('overlay').style.display='none'; 
            selectLevel(levelList[currentIdx + 1].id);
        } else { document.getElementById('overlay').style.display='none'; }
    }
    
    function switchMode(m) { 
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
        document.getElementById('tab-'+m).classList.add('active'); 
        document.getElementById('quiz-ui').style.display = (m==='learning')?'flex':'none'; 
        document.getElementById('search-results-list').innerHTML = ''; updateMap(); 
    }

    function downloadProgress() { const b = new Blob([JSON.stringify({stats, currentLevel})], {type: "text/plain"}); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `polish_progress.txt`; a.click(); }
    function importProgress(event) { const r = new FileReader(); r.onload = (ev) => { const d = JSON.parse(ev.target.result); stats = d.stats; currentLevel = d.currentLevel; saveStats(); location.reload(); }; r.readAsText(event.target.files[0]); }
    function resetEverything() { if(confirm("Clear all?")) { localStorage.clear(); location.reload(); } }
    
    // Help overlay logic
    function toggleHelp() {
        const el = document.getElementById('help-overlay');
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    document.addEventListener('click', () => { initAudioContext(); enableAudioKeepAlive(); }, {once: true});
    document.addEventListener('touchstart', () => { initAudioContext(); enableAudioKeepAlive(); }, {once: true});
    
    window.onclick = (e) => {
        if (!e.target.matches('.dropdown-trigger') && !e.target.matches('.gender-dropdown-trigger')) {
             document.querySelectorAll('.dropdown-menu, .gender-dropdown-menu').forEach(m => m.classList.remove('show'));
        }
    };
    window.onload = () => { initSpeech(); updateUILanguage(); loadLevelData(); };

    // --- HANDS FREE LOGIC ---
    let hfActive = false;
    let hfIndex = 0;
    let hfPhrases = [];
    let hfPauseDur = 3000;
    let hfAbort = false;
    let hfIsPaused = false;
    let hfCountdownTimer = null;

    function setPauseDuration(sec) {
        hfPauseDur = sec * 1000;
        document.querySelectorAll('.pause-option').forEach(o => o.classList.remove('active'));
        event.target.classList.add('active');
    }

    async function openHandsFree() {
        hfActive = true; hfAbort = false; hfIsPaused = false;
        initAudioContext(); enableAudioKeepAlive(); 

        if (!phrasesData || phrasesData.length === 0) await loadLevelData();
        hfPhrases = phrasesData;
        const savedIdx = localStorage.getItem('hf_mem_' + currentLevel);
        hfIndex = savedIdx ? parseInt(savedIdx) : 0;
        if(hfIndex >= hfPhrases.length) hfIndex = 0;

        document.getElementById('hf-overlay').style.display = 'flex';
        document.getElementById('hf-level-indicator').innerText = document.getElementById('lvl-current').innerText;
        document.getElementById('hf-active-view').style.display = 'flex';
        document.getElementById('hf-done-view').style.display = 'none';
        document.getElementById('hf-controls-active').style.display = 'flex';
        document.getElementById('hf-controls-done').style.display = 'none';

        runHandsFreeLoop();
    }

    function closeHandsFree() {
        hfActive = false; hfAbort = true; 
        clearTimeout(hfCountdownTimer);
        window.speechSynthesis.cancel();
        document.getElementById('hf-overlay').style.display = 'none';
        startNewRound();
    }

    function togglePlayPauseHF() {
        if(hfIsPaused) {
            hfIsPaused = false;
            document.getElementById('hf-pp-btn').innerText = "‚è∏ Pause";
            runHandsFreeLoop();
        } else {
            hfIsPaused = true;
            hfAbort = true;
            window.speechSynthesis.cancel();
            document.getElementById('hf-pp-btn').innerText = "‚ñ∂ Resume";
        }
    }

    function skipPhraseHF() {
        hfAbort = true;
        setTimeout(() => {
            hfAbort = false; 
            hfIndex++;
            runHandsFreeLoop();
        }, 100);
    }

    async function runHandsFreeLoop() {
        hfAbort = false;
        while (hfActive && !hfIsPaused && hfIndex < hfPhrases.length) {
            const p = hfPhrases[hfIndex];
            document.getElementById('hf-pl').innerText = p.pl;
            document.getElementById('hf-en').innerText = p.en;
            document.getElementById('hf-counter').innerText = `${hfIndex + 1} / ${hfPhrases.length}`;
            document.getElementById('hf-bar').style.width = ((hfIndex / hfPhrases.length) * 100) + "%";
            localStorage.setItem('hf_mem_' + currentLevel, hfIndex);

            let plText = p.pl;
            if(currentLevel === "0") plText = p.pl + " jak " + p.word;

            await speakAsync(plText, 1.0); if(hfAbort) break;
            await sleep(hfPauseDur); if(hfAbort) break;
            await speakAsync(p.en, 1.0, 'en-US'); if(hfAbort) break;
            await sleep(hfPauseDur); if(hfAbort) break;
            await speakAsync(plText, 0.5); if(hfAbort) break;
            await sleep(hfPauseDur); if(hfAbort) break;
            await speakAsync(plText, 1.0); if(hfAbort) break;
            await sleep(1000); if(hfAbort) break;

            hfIndex++;
        }

        if (hfIndex >= hfPhrases.length && !hfIsPaused && !hfAbort) {
            handleLevelCompleteHF();
        }
    }

    function handleLevelCompleteHF() {
        playSuccess();
        document.getElementById('hf-active-view').style.display = 'none';
        document.getElementById('hf-controls-active').style.display = 'none';
        
        document.getElementById('hf-done-view').style.display = 'flex';
        document.getElementById('hf-controls-done').style.display = 'flex';
        localStorage.removeItem('hf_mem_' + currentLevel);

        let secondsLeft = 10;
        const timerEl = document.getElementById('hf-timer-val');
        
        clearInterval(hfCountdownTimer);
        hfCountdownTimer = setInterval(() => {
            secondsLeft--;
            timerEl.innerText = secondsLeft;
            if (secondsLeft <= 0) {
                clearInterval(hfCountdownTimer);
                forceNextLevelHF();
            }
        }, 1000);
    }

    function restartLevelHF() {
        clearInterval(hfCountdownTimer);
        hfIndex = 0;
        document.getElementById('hf-done-view').style.display = 'none';
        document.getElementById('hf-controls-done').style.display = 'none';
        document.getElementById('hf-active-view').style.display = 'flex';
        document.getElementById('hf-controls-active').style.display = 'flex';
        runHandsFreeLoop();
    }

    async function forceNextLevelHF() {
        clearInterval(hfCountdownTimer);
        const currentIdx = levelList.findIndex(l => l.id == currentLevel);
        if (currentIdx !== -1 && currentIdx < levelList.length - 1) {
            const nextLvlId = levelList[currentIdx + 1].id;
            currentLevel = nextLvlId;
            saveStats();
            try {
                const resp = await fetch(`phrases_${currentLevel}.json?v=${Date.now()}`);
                const data = await resp.json();
                phrasesData = data.phrases;
                hfPhrases = phrasesData;
                hfIndex = 0;
                let label = data.description || `Level ${currentLevel}`;
                if (!label.startsWith(currentLevel)) label = `Lvl ${currentLevel}: ${label}`;
                document.getElementById('lvl-current').innerText = label;
                document.getElementById('hf-level-indicator').innerText = label;
                restartLevelHF(); 
            } catch(e) {
                alert("End of content reached!");
                closeHandsFree();
            }
        } else {
            alert("No more levels!");
            closeHandsFree();
        }
    }

    function speakAsync(text, rate = 1.0, lang = 'pl-PL') {
        return new Promise(resolve => {
            if (hfAbort || hfIsPaused) { resolve(); return; }
            initAudioContext(); enableAudioKeepAlive(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang; u.rate = rate; 
            u.onend = () => resolve(); 
            u.onerror = () => resolve();
            speechSynthesis.speak(u);
        });
    }

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    function updateTabCounts() {
        if (!phrasesData.length) return;
        const masteredCount = phrasesData.filter(p => (stats[p.pl] || 0) >= THRESHOLD).length;
        const practiceCount = phrasesData.length - masteredCount;
        
        const pNum = `(${practiceCount})`;
        const bNum = `(${masteredCount})`;
        
        document.getElementById('tab-learning').innerHTML = `${t('practice')} <span id="learning-count">${pNum}</span>`;
        document.getElementById('tab-mastered').innerHTML = `${t('banked')} <span id="banked-count">${bNum}</span>`;
    }

    let lastSpeakerTap = 0;
    async function handleSpeakerTap() {
        const now = Date.now();
        initAudioContext(); enableAudioKeepAlive();

        if (!currentTarget) return; 
        
        const textToSpeak = currentLevel === "0" ? (currentTarget.pl + " jak " + currentTarget.word) : currentTarget.pl;
        
        if (now - lastSpeakerTap < 300) {
            speak(textToSpeak, 0.5); 
        } else {
            speak(textToSpeak, 1.0); 
        }
        lastSpeakerTap = now;
    }
</script>
</body>
</html>
