<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Phrase Master</title>
    <style>
        :root { --pol-red: #dc143c; --wrong-blue: #3498db; --bg: #f0f2f5; --card: #ffffff; --text: #333; --tile-bg: #dee2e6; --accent-blue: #1976d2; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --tile-bg: #404040; --accent-blue: #42a5f5; } }
        
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; color: var(--text); }
        
        .header { width: 100%; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .title-banner { background: linear-gradient(to bottom, #ffffff 50%, #dc143c 50%); padding: 8px 0; border-bottom: 1px solid #ccc; }
        .title { font-weight: 800; font-size: 1rem; color: #333; text-align: center; margin: 0; }
        .controls-row { width: 90%; max-width: 400px; margin: 0 auto; padding: 6px 0; display: flex; flex-direction: column; gap: 6px; }
        
        .custom-dropdown { position: relative; width: 100%; }
        .dropdown-trigger { 
            width: 100%; background: var(--bg); border: 1px solid #ccc; color: var(--text); 
            padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; 
            text-align: left; height: 28px; display: flex; align-items: center; 
            justify-content: space-between; cursor: pointer; box-sizing: border-box;
        }
        .dropdown-trigger::after { content: 'â–¼'; font-size: 7px; color: #888; }
        .dropdown-menu { 
            position: absolute; top: 100%; left: 0; right: 0; background: var(--card); 
            border: 1px solid #ccc; border-radius: 4px; max-height: 250px; overflow-y: auto; 
            z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 8px 10px; font-size: 10px; border-bottom: 1px solid #eee; cursor: pointer; color: var(--text); display: flex; justify-content: space-between; align-items: center; }

        .progress-container { width: 100%; height: 3px; background: #ddd; }
        #progress-bar { width: 0%; height: 100%; background: var(--pol-red); transition: width 0.5s; }

        .quiz-header { background: var(--card); padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; }
        .quiz-top-row { display: flex; align-items: center; gap: 12px; width: 100%; justify-content: center; }
        .speaker-btn { background: var(--bg); border: 1px solid #ddd; border-radius: 50%; width: 42px; height: 42px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .handsfree-btn { background: var(--bg); border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; cursor: pointer; }
        .handsfree-btn.active { background: #2ecc71; color: white; border-color: #27ae60; }
        
        .q-text { font-size: 1rem; font-weight: 800; text-align: center; max-width: 220px; word-wrap: break-word; }
        .feedback { height: 12px; font-size: 0.7rem; font-weight: bold; margin-top: 4px; }

        .mode-tabs { display: flex; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 12px 1px; text-align: center; font-size: 0.52rem; font-weight: bold; cursor: pointer; opacity: 0.4; transition: 0.2s; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--pol-red); color: var(--pol-red); }

        .map-section { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box; }
        .grid { display: grid; gap: 8px; width: 100%; max-width: 400px; }
        .grid-standard { grid-template-columns: repeat(4, 1fr); } 
        .grid-alphabet { grid-template-columns: repeat(5, 1fr); gap: 4px; }
        
        .tile { 
            aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: var(--tile-bg); border-radius: 8px; cursor: pointer; padding: 4px; text-align: center;
        }
        .tile .char { font-size: 0.7rem; font-weight: 800; color: var(--text); }
        .tile .hint { font-size: 0.45rem; opacity: 0.7; }
        .tile .emoji { font-size: 0.7rem; }
        .tile.wrong { background: var(--wrong-blue) !important; color: white !important; }

        .footer { padding: 8px 8px 24px 8px; display: flex; justify-content: center; gap: 6px; border-top: 1px solid #ddd; background: var(--card); flex-shrink: 0; }
        .footer-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.6rem; padding: 6px; border-radius: 6px; cursor: pointer; flex: 1; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: white; }
    </style>
</head>
<body>

<div id="overlay">
    <h1>LEVEL MASTERED! ğŸ†</h1>
    <button onclick="advanceLevel()" style="padding: 15px 30px; background: var(--pol-red); color: white; border: none; border-radius: 8px; font-weight: bold;">Continue</button>
</div>

<div class="header">
    <div class="title-banner"><h1 class="title">Polish Phrase Master</h1></div>
    <div class="controls-row">
        <div class="custom-dropdown">
            <div class="dropdown-trigger" id="lvl-current" onclick="toggleDropdown(event)">Select Level</div>
            <div class="dropdown-menu" id="lvl-menu"></div>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <input type="text" id="search-bar" style="flex:1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Search..." oninput="handleSmartSearch()">
            <button id="hf-toggle" class="handsfree-btn" onclick="toggleHandsfree()">Handsfree: OFF</button>
        </div>
    </div>
</div>

<div class="progress-container"><div id="progress-bar"></div></div>

<div class="quiz-header" id="quiz-ui">
    <div class="quiz-top-row">
        <button class="speaker-btn" onclick="speakTarget()">ğŸ”Š</button>
        <div class="q-content">
            <div id="q-text" class="q-text">Ready?</div>
            <div id="feedback" class="feedback"></div>
        </div>
    </div>
</div>

<div class="mode-tabs">
    <div id="tab-learning" class="tab active" onclick="switchMode('learning')">LEARNING</div>
    <div id="tab-mastered" class="tab" onclick="switchMode('mastered')">BANK</div>
    <div id="tab-test" class="tab" onclick="switchMode('test')">MARATHON</div>
    <div id="tab-phrasebook" class="tab" onclick="switchMode('phrasebook')">PHRASEBOOK</div>
</div>

<div class="map-section">
    <div id="mastery-map" class="grid"></div>
</div>

<div class="footer">
    <button class="footer-btn" onclick="downloadProgress()">Save</button>
    <button class="footer-btn" onclick="document.getElementById('file-input').click()">Load</button>
    <button class="footer-btn" onclick="resetEverything()" style="color:red">Reset</button>
    <input type="file" id="file-input" style="display:none" onchange="importProgress(event)">
</div>

<script>
    const alphaMap = {
        'A': {h:'ah', e:'ğŸš—', w:'Auto'}, 'Ä„': {h:'own', e:'ğŸŒ¾', w:'MÄ…ka'}, 'B': {h:'b', e:'ğŸ‘', w:'But'},
        'C': {h:'ts', e:'ğŸ¬', w:'Cukier'}, 'Ä†': {h:'ch!', e:'ğŸ¦‹', w:'Ä†ma'}, 'CH': {h:'h', e:'ğŸ', w:'Chleb'},
        'CZ': {h:'ch', e:'â±ï¸', w:'Czas'}, 'D': {h:'d', e:'ğŸ ', w:'Dom'}, 'DZ': {h:'dz', e:'ğŸ””', w:'Dzwon'},
        'DÅ¹': {h:'j!', e:'ğŸ”Š', w:'DÅºwiÄ™k'}, 'DÅ»': {h:'j', e:'ğŸ“', w:'DÅ¼em'}, 'E': {h:'eh', e:'ğŸ“±', w:'Ekran'},
        'Ä˜': {h:'en', e:'ğŸ¦¢', w:'GÄ™Å›'}, 'F': {h:'f', e:'ğŸ¨', w:'Farba'}, 'G': {h:'g', e:'ğŸ”ï¸', w:'GÃ³ra'},
        'H': {h:'h', e:'ğŸµ', w:'Herbata'}, 'I': {h:'ee', e:'ğŸ†”', w:'ImiÄ™'}, 'J': {h:'y', e:'ğŸ¥š', w:'Jajko'},
        'K': {h:'k', e:'ğŸ±', w:'Kot'}, 'L': {h:'l', e:'ğŸ’¡', w:'Lampa'}, 'Å': {h:'w', e:'â›µ', w:'ÅÃ³dÅº'},
        'M': {h:'m', e:'ğŸ‘©', w:'Mama'}, 'N': {h:'n', e:'ğŸŒ™', w:'Noc'}, 'Åƒ': {h:'ny', e:'ğŸ', w:'KoÅ„'},
        'O': {h:'oh', e:'ğŸªŸ', w:'Okno'}, 'Ã“': {h:'oo', e:'ğŸŒ³', w:'OgrÃ³d'}, 'P': {h:'p', e:'ğŸ¶', w:'Pies'},
        'R': {h:'r', e:'âœ‹', w:'RÄ™ka'}, 'RZ': {h:'zh', e:'ğŸŒŠ', w:'Rzeka'}, 'S': {h:'s', e:'ğŸ§€', w:'Ser'},
        'Åš': {h:'sh!', e:'â„ï¸', w:'Åšnieg'}, 'SZ': {h:'sh', e:'ğŸ‘—', w:'Szafa'}, 'T': {h:'t', e:'ğŸ‘', w:'Tak'},
        'U': {h:'oo', e:'ğŸ‘‚', w:'Ucho'}, 'W': {h:'v', e:'ğŸ’§', w:'Woda'}, 'Y': {h:'i', e:'ğŸ‘¦', w:'Syn'},
        'Z': {h:'z', e:'ğŸ¦·', w:'ZÄ…b'}, 'Å¹': {h:'zh!', e:'ğŸ‘', w:'Å¹le'}, 'Å»': {h:'zh', e:'ğŸ¸', w:'Å»aba'}
    };

    let stats = JSON.parse(localStorage.getItem('pl_mastery_final')) || {};
    let currentLevel = parseInt(localStorage.getItem('pl_current_level_idx')) || 0;
    let phrasesData = [], activePool = [], currentTarget = null;
    let isHandsfree = false, hfTimeout = null, currentMode = 'learning';

    function toggleHandsfree() {
        isHandsfree = !isHandsfree;
        const btn = document.getElementById('hf-toggle');
        btn.innerText = `Handsfree: ${isHandsfree ? 'ON' : 'OFF'}`;
        btn.classList.toggle('active', isHandsfree);
        if (isHandsfree) startRound(); else clearTimeout(hfTimeout);
    }

    async function scanLevels() {
        const menu = document.getElementById('lvl-menu'); menu.innerHTML = '';
        for (let i = 0; i < 100; i++) {
            try {
                const res = await fetch(`phrases_${i}.json`);
                if (!res.ok) continue;
                const data = await res.json();
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerHTML = `Lvl ${i}: ${data.description}`;
                item.onclick = () => { currentLevel = i; loadLevel(); toggleDropdown(); };
                menu.appendChild(item);
                if (i === currentLevel) document.getElementById('lvl-current').innerText = `Lvl ${i}: ${data.description}`;
            } catch(e) {}
        }
    }

    function loadLevel() {
        fetch(`phrases_${currentLevel}.json`).then(r => r.json()).then(data => {
            phrasesData = data.phrases;
            activePool = phrasesData.filter(p => (stats[p.pl] || 0) < 3).slice(0, 12);
            updateUI();
        });
    }

    function updateUI() {
        const area = document.getElementById('mastery-map'); area.innerHTML = '';
        area.className = (currentLevel === 0) ? "grid grid-alphabet" : "grid grid-standard";
        if (activePool.length === 0) {
            area.innerHTML = `<div style="text-align:center; padding:20px;"><h2>Level Mastered!</h2></div>`;
            return;
        }
        activePool.forEach(p => {
            const tile = document.createElement('div'); tile.className = 'tile';
            if (currentLevel === 0) {
                const m = alphaMap[p.pl] || {};
                tile.innerHTML = `<span class="char">${p.pl}</span><span class="hint">${m.h || ''}</span><span class="emoji">${m.e || ''}</span>`;
            } else {
                tile.innerHTML = `<span class="char" style="font-size:0.6rem">${p.pl}</span>`;
            }
            tile.onclick = () => checkAnswer(p, tile);
            area.appendChild(tile);
        });
        startRound();
    }

    function startRound() {
        if (!activePool.length) return;
        currentTarget = activePool[Math.floor(Math.random() * activePool.length)];
        document.getElementById('q-text').innerText = (currentLevel === 0) ? (alphaMap[currentTarget.pl]?.w || currentTarget.en) : currentTarget.en;
        speak(currentTarget.pl);
        if (isHandsfree) {
            clearTimeout(hfTimeout);
            hfTimeout = setTimeout(() => {
                if (isHandsfree) checkAnswer(currentTarget, null);
            }, 4000); 
        }
    }

    function checkAnswer(p, el) {
        if (p.pl === currentTarget.pl) {
            stats[p.pl] = (stats[p.pl] || 0) + 1;
            document.getElementById('feedback').innerText = "Dobrze!";
            localStorage.setItem('pl_mastery_final', JSON.stringify(stats));
            setTimeout(() => {
                if (stats[p.pl] >= 3) activePool = activePool.filter(x => x.pl !== p.pl);
                updateUI();
            }, 600);
        } else if (el) {
            el.classList.add('wrong');
            setTimeout(() => el.classList.remove('wrong'), 500);
        }
    }

    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang='pl-PL'; window.speechSynthesis.speak(m); }
    function speakTarget() { if(currentTarget) speak(currentTarget.pl); }
    function toggleDropdown() { document.getElementById('lvl-menu').classList.toggle('show'); }
    function switchMode(m) { /* Mode logic */ }
    window.onload = () => { scanLevels(); loadLevel(); };
</script>
</body>
</html>
