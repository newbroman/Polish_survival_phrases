<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Phrase Master</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc143c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Polish Quiz">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root { --pol-red: #dc143c; --wrong-blue: #3498db; --bg: #f0f2f5; --card: #ffffff; --text: #333; --tile-bg: #dee2e6; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --tile-bg: #404040; } }
        
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; background: var(--bg); color: var(--text); }
        body { font-family: -apple-system, system-ui, sans-serif; display: flex; flex-direction: column; }

        /* Header & Navigation */
        .header { padding: 10px 15px; background: var(--card); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10; }
        .title-banner { text-align: center; margin-bottom: 8px; }
        .title { margin: 0; font-size: 1.2rem; color: var(--pol-red); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        
        .controls-row { display: flex; gap: 8px; align-items: center; }
        
        /* Dropdown Styling */
        .custom-dropdown { position: relative; flex: 1; }
        .dropdown-trigger { background: var(--tile-bg); padding: 8px 12px; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.2s; }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; width: 200px; background: var(--card); box-shadow: 0 8px 24px rgba(0,0,0,0.2); border-radius: 12px; max-height: 400px; overflow-y: auto; z-index: 1000; margin-top: 10px; border: 1px solid var(--tile-bg); }
        .dropdown-menu.show { display: block; animation: slideDown 0.2s ease-out; }
        .dropdown-item { padding: 12px 16px; border-bottom: 1px solid var(--tile-bg); cursor: pointer; font-size: 0.9rem; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item.active-level { background: var(--pol-red); color: white; font-weight: bold; }

        .search-box { flex: 2; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--tile-bg); background: var(--bg); color: var(--text); font-size: 0.9rem; outline: none; }
        .search-box:focus { border-color: var(--pol-red); }

        /* Hands-Free Panel */
        .handsfree-controls { display: none; flex-direction: column; background: var(--pol-red); color: white; padding: 20px; gap: 15px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        #hf-display-pl { font-size: 1.8rem; font-weight: 800; text-align: center; min-height: 2.2rem; }
        #hf-display-en { font-size: 1.1rem; opacity: 0.85; text-align: center; font-style: italic; }
        
        .hf-bottom-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .handsfree-btn { background: white; color: var(--pol-red); border: none; padding: 10px 20px; border-radius: 25px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .pause-selector { display: flex; gap: 8px; background: rgba(0,0,0,0.1); padding: 4px; border-radius: 10px; }
        .pause-option { padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
        .pause-option.active { background: white; color: var(--pol-red); }

        /* Quiz UI */
        .quiz-header { padding: 30px 20px; text-align: center; background: var(--card); flex-shrink: 0; }
        .q-text { font-size: 1.6rem; font-weight: 800; margin-bottom: 10px; color: var(--text); }
        .feedback { height: 24px; color: var(--pol-red); font-weight: bold; margin-top: 5px; }

        /* Tile Grid */
        .map-section { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; align-content: start; }
        .tile { aspect-ratio: 1; background: var(--tile-bg); border-radius: 10px; cursor: pointer; transition: transform 0.1s, background 0.3s; position: relative; }
        .tile.mastered { background: var(--pol-red); box-shadow: 0 2px 8px rgba(220, 20, 60, 0.3); }
        .tile:active { transform: scale(0.9); }

        /* Tabs & Progress */
        .progress-container { height: 6px; background: var(--tile-bg); width: 100%; }
        #progress-bar { height: 100%; background: var(--pol-red); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        .mode-tabs { display: flex; background: var(--card); border-top: 1px solid var(--tile-bg); }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 0.75rem; font-weight: 800; cursor: pointer; opacity: 0.5; transition: 0.3s; letter-spacing: 0.5px; }
        .tab.active { opacity: 1; color: var(--pol-red); border-bottom: 4px solid var(--pol-red); }

        .footer { padding: 15px; display: flex; gap: 12px; background: var(--card); border-top: 1px solid var(--tile-bg); }
        .footer-btn { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--tile-bg); background: var(--card); color: var(--text); font-weight: bold; font-size: 0.8rem; cursor: pointer; }

        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); color:white; z-index:2000; flex-direction:column; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="font-size: 2.5rem; margin-bottom: 10px;">ÅšWIETNIE!</h1>
    <p style="margin-bottom: 30px; font-size: 1.2rem;">Level complete.</p>
    <button onclick="advanceLevel()" style="padding: 15px 40px; background: var(--pol-red); color: white; border: none; border-radius: 30px; font-weight: 800; font-size: 1.1rem; cursor:pointer;">NEXT LEVEL</button>
</div>

<div class="header">
    <div class="title-banner"><h1 class="title">Survival Polish</h1></div>
    <div class="controls-row">
        <div class="custom-dropdown">
            <div class="dropdown-trigger" id="lvl-current" onclick="toggleDropdown(event)">Scanning...</div>
            <div class="dropdown-menu" id="lvl-menu"></div>
        </div>
        <input type="text" id="search-bar" class="search-box" placeholder="Search..." oninput="handleSmartSearch()">
        <button id="hf-toggle-btn" class="footer-btn" style="max-width: 110px;" onclick="toggleHandsFreePanel()">â–¼ Hands-Free</button>
    </div>
</div>

<div class="handsfree-controls" id="handsfree-controls">
    <div id="hf-display-pl">Gotowy?</div>
    <div id="hf-display-en">Press Start</div>
    <div class="hf-bottom-nav">
        <div class="pause-selector">
            <div class="pause-option active" onclick="setPauseDuration(1)">1s</div>
            <div class="pause-option" onclick="setPauseDuration(3)">3s</div>
            <div class="pause-option" onclick="setPauseDuration(5)">5s</div>
        </div>
        <button class="handsfree-btn" id="hf-toggle" onclick="toggleHandsFree()">â–¶ START</button>
        <button class="handsfree-btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="toggleHandsFreePanel()">âœ•</button>
    </div>
</div>

<div class="progress-container"><div id="progress-bar"></div></div>

<div class="quiz-header">
    <div id="q-text" class="q-text">Loading phrases...</div>
    <div id="feedback" class="feedback"></div>
</div>

<div class="mode-tabs">
    <div id="tab-learning" class="tab active" onclick="switchMode('learning')">PRACTICE <span id="learning-count"></span></div>
    <div id="tab-mastered" class="tab" onclick="switchMode('mastered')">BANKED <span id="banked-count"></span></div>
</div>

<div class="map-section" id="mastery-map"></div>
<div id="search-results-extra"></div>

<div class="footer">
    <button class="footer-btn" onclick="saveData()">Save Progress</button>
    <button class="footer-btn" onclick="resetStats()" style="color: var(--pol-red); border-color: var(--pol-red);">Clear</button>
</div>

<script>
    // --- Configuration & State ---
    const THRESHOLD = 3;
    let phrasesData = [], levelOrder = [], activePool = [];
    let currentLevel = parseFloat(localStorage.getItem('pl_current_level_idx')) || 0;
    let stats = JSON.parse(localStorage.getItem('pl_stats')) || {};
    let currentTarget = null;
    let handsFreeActive = false, handsFreeAbort = false;
    let pauseDuration = 1000;
    let currentMode = 'learning';
    let plVoice = null;

    // --- 1. Automatic Level Scanner ---
    async function scanForLevels() {
        levelOrder = [];
        const maxCheck = 40;
        const probes = [];
        
        for (let i = 0; i <= maxCheck; i++) {
            probes.push(i);
            for (let d = 1; d <= 9; d++) probes.push(parseFloat(`${i}.${d}`));
        }

        const results = await Promise.all(probes.map(async (n) => {
            try {
                const r = await fetch(`phrases_${n}.json`, { method: 'HEAD' });
                return r.ok ? n : null;
            } catch (e) { return null; }
        }));

        levelOrder = results.filter(n => n !== null).sort((a, b) => a - b);
        populateDropdown();

        if (levelOrder.length > 0) {
            const last = localStorage.getItem('pl_current_level_idx');
            const toLoad = (last && levelOrder.includes(parseFloat(last))) ? parseFloat(last) : levelOrder[0];
            await selectLevel(toLoad);
        }
    }

    // --- 2. Core App Logic ---
    async function selectLevel(num) {
        currentLevel = num;
        localStorage.setItem('pl_current_level_idx', num);
        document.getElementById('lvl-current').innerText = `Level ${num}`;
        
        try {
            const resp = await fetch(`phrases_${num}.json`);
            const data = await resp.json();
            phrasesData = data.phrases;
            refreshApp();
            document.getElementById('lvl-menu').classList.remove('show');
        } catch (e) { 
            console.error("Failed to load level", e);
            document.getElementById('q-text').innerText = "Level file missing!";
        }
    }

    function refreshApp() {
        updateMap();
        updateStats();
        updateTabCounts();
        startNewRound();
        populateDropdown(); 
    }

    function updateMap() {
        const map = document.getElementById('mastery-map');
        map.innerHTML = '';
        phrasesData.forEach(p => {
            const score = stats[p.pl] || 0;
            const mastered = score >= THRESHOLD;
            if (currentMode === 'learning' && mastered) return;
            if (currentMode === 'mastered' && !mastered) return;

            const tile = document.createElement('div');
            tile.className = 'tile' + (mastered ? ' mastered' : '');
            tile.onclick = () => {
                currentTarget = p;
                document.getElementById('q-text').innerText = p.en;
                speak(p.pl);
            };
            map.appendChild(tile);
        });
    }

    function startNewRound() {
        const pool = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD);
        if (pool.length > 0) {
            currentTarget = pool[Math.floor(Math.random() * pool.length)];
            document.getElementById('q-text').innerText = currentTarget.en;
            document.getElementById('feedback').innerText = '';
        } else {
            document.getElementById('q-text').innerText = "Level Complete! ðŸŽ‰";
        }
    }

    // --- 3. Speech & Hands-Free ---
    function initSpeech() {
        const loadVoices = () => {
            plVoice = speechSynthesis.getVoices().find(v => v.lang.startsWith('pl'));
        };
        loadVoices();
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speak(text, lang = 'pl-PL', rate = 0.9) {
        return new Promise(resolve => {
            if (handsFreeAbort && lang === 'pl-PL') { resolve(); return; }
            const u = new SpeechSynthesisUtterance(text);
            if (lang === 'pl-PL' && plVoice) u.voice = plVoice;
            u.lang = lang; u.rate = rate;
            u.onend = () => resolve();
            u.onerror = () => resolve();
            speechSynthesis.speak(u);
        });
    }

    async function toggleHandsFree() {
        if (handsFreeActive) {
            handsFreeActive = false;
            handsFreeAbort = true;
            speechSynthesis.cancel();
            document.getElementById('hf-toggle').innerText = 'â–¶ START';
        } else {
            handsFreeActive = true;
            handsFreeAbort = false;
            document.getElementById('hf-toggle').innerText = 'â¹ STOP';
            runHandsFreeLoop();
        }
    }

    async function runHandsFreeLoop() {
        while (handsFreeActive && !handsFreeAbort) {
            let pool = phrasesData.filter(p => (stats[p.pl] || 0) < THRESHOLD);
            if (pool.length === 0) {
                await handleLevelTransition();
                return;
            }

            let p = pool[Math.floor(Math.random() * pool.length)];
            document.getElementById('hf-display-en').innerText = p.en;
            document.getElementById('hf-display-pl').innerText = '...';
            
            await speak(p.en, 'en-US', 1.0);
            await new Promise(r => setTimeout(r, pauseDuration));
            
            document.getElementById('hf-display-pl').innerText = p.pl;
            await speak(p.pl, 'pl-PL', 0.85);
            
            stats[p.pl] = (stats[p.pl] || 0) + 1;
            updateStats();
            await new Promise(r => setTimeout(r, 1500));
        }
    }

    async function handleLevelTransition() {
        const idx = levelOrder.indexOf(currentLevel);
        if (idx < levelOrder.length - 1) {
            const next = levelOrder[idx + 1];
            await speak("Level complete. Moving to level " + next, 'en-US', 1.0);
            await selectLevel(next);
        } else {
            handsFreeActive = false;
            document.getElementById('hf-toggle').innerText = 'â–¶ START';
            document.getElementById('overlay').style.display = 'flex';
        }
    }

    // --- 4. UI Helpers ---
    function toggleDropdown(e) {
        e.stopPropagation();
        document.getElementById('lvl-menu').classList.toggle('show');
    }

    function populateDropdown() {
        const menu = document.getElementById('lvl-menu');
        menu.innerHTML = '';
        levelOrder.forEach(n => {
            const div = document.createElement('div');
            div.className = 'dropdown-item' + (n === currentLevel ? ' active-level' : '');
            div.innerText = `Level ${n}`;
            div.onclick = () => selectLevel(n);
            menu.appendChild(div);
        });
    }

    function switchMode(m) {
        currentMode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${m}`).classList.add('active');
        updateMap();
    }

    function setPauseDuration(s) {
        pauseDuration = s * 1000;
        document.querySelectorAll('.pause-option').forEach(o => o.classList.toggle('active', parseInt(o.innerText) === s));
    }

    function toggleHandsFreePanel() {
        const p = document.getElementById('handsfree-controls');
        const isHidden = p.style.display === 'none' || !p.style.display;
        p.style.display = isHidden ? 'flex' : 'none';
        document.getElementById('hf-toggle-btn').innerText = isHidden ? 'â–² Hands-Free' : 'â–¼ Hands-Free';
    }

    function updateStats() {
        const mastered = phrasesData.filter(p => (stats[p.pl] || 0) >= THRESHOLD).length;
        const progress = phrasesData.length ? (mastered / phrasesData.length) * 100 : 0;
        document.getElementById('progress-bar').style.width = progress + '%';
        localStorage.setItem('pl_stats', JSON.stringify(stats));
    }

    function updateTabCounts() {
        const mastered = phrasesData.filter(p => (stats[p.pl] || 0) >= THRESHOLD).length;
        document.getElementById('learning-count').innerText = `(${phrasesData.length - mastered})`;
        document.getElementById('banked-count').innerText = `(${mastered})`;
    }

    function handleSmartSearch() {
        const term = document.getElementById('search-bar').value.toLowerCase();
        const results = document.getElementById('search-results-extra');
        results.innerHTML = '';
        if (!term) { updateMap(); return; }
        const found = phrasesData.filter(p => p.en.toLowerCase().includes(term) || p.pl.toLowerCase().includes(term));
        found.forEach(p => {
            const d = document.createElement('div');
            d.style.padding = '10px';
            d.style.borderBottom = '1px solid var(--tile-bg)';
            d.innerText = `${p.en} â†’ ${p.pl}`;
            d.onclick = () => { speak(p.pl); document.getElementById('q-text').innerText = p.en; };
            results.appendChild(d);
        });
    }

    function advanceLevel() {
        document.getElementById('overlay').style.display = 'none';
        const idx = levelOrder.indexOf(currentLevel);
        if (idx < levelOrder.length - 1) selectLevel(levelOrder[idx + 1]);
    }

    function resetStats() {
        if (confirm("Reset all progress for this level?")) {
            phrasesData.forEach(p => delete stats[p.pl]);
            refreshApp();
        }
    }

    function saveData() {
        const blob = new Blob([JSON.stringify(stats)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'polish_progress.json';
        a.click();
    }

    // --- Initialization ---
    window.onload = () => {
        initSpeech();
        scanForLevels();
    };
    window.onclick = () => document.getElementById('lvl-menu').classList.remove('show');

    // Service Worker for Offline Use
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        });
    }
</script>

</body>
</html>
