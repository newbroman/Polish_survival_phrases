<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Phrase Master v3.4</title>
    <style>
        /* CSS remains consistent with previous v3.2/3.3 styles */
        :root { --pol-red: #dc143c; --wrong-blue: #3498db; --bg: #f0f2f5; --card: #ffffff; --text: #333; --tile-bg: #dee2e6; --gold: #ffd700; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --tile-bg: #404040; } }
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; color: var(--text); }
        .header { width: 100%; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .controls-row { width: 90%; max-width: 400px; margin: 0 auto; padding: 6px 0; display: flex; flex-direction: column; gap: 6px; }
        .search-row { display: flex; gap: 6px; width: 100%; }
        .search-box { flex: 1; background: var(--bg); border: 1px solid #ccc; padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; height: 28px; outline: none; }
        .help-btn-inline { width: 28px; height: 28px; border-radius: 4px; border: 1px solid #ccc; font-weight: 900; color: var(--pol-red); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .gender-dropdown { position: relative; flex: 1; }
        .gender-dropdown-trigger { width: 100%; background: var(--bg); border: 1px solid #ccc; padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; height: 28px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .gender-dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid #ccc; border-radius: 4px; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .gender-dropdown-menu.show { display: block; }
        .gender-dropdown-item { padding: 8px 10px; font-size: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .tile { min-height: 70px; display: flex; align-items: center; justify-content: center; background: var(--tile-bg); border-radius: 6px; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 0px rgba(0,0,0,0.15); border: 2px solid transparent; word-wrap: break-word; }
        .tile.mastered-border { border-color: var(--gold); }
        .tile.wrong { background: var(--wrong-blue) !important; color: white !important; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; width: 100%; max-width: 360px; margin: 0 auto; }
        .map-section { flex-grow: 1; padding: 10px 8px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; width: 100%; }
        #help-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .help-modal { background: var(--card); padding: 25px; border-radius: 12px; max-width: 90%; width: 400px; max-height: 80vh; overflow-y: auto; position: relative; font-size: 0.9rem; }
        .help-close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; border: none; background: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="help-overlay">
    <div class="help-modal">
        <button class="help-close" onclick="toggleHelp()">×</button>
        <h2 style="color:var(--pol-red)">Help & Levels</h2>
        <p><b>Level 2 Practice:</b> This level introduces gender-coded adjectives. Ensure your Gender toggle is set to <b>Male</b> or <b>Female</b> to see how words like <i>'Zajęty'</i> change.</p>
        <p><b>Search:</b> You can now search for "Car" or "Hospital" to find survival phrases in Level 2.1.</p>
    </div>
</div>

<div class="header">
    <div class="controls-row">
        <div class="gender-dropdown">
            <div class="gender-dropdown-trigger" id="gender-current" onclick="toggleGenderDropdown(event)">Gender: Both</div>
            <div class="gender-dropdown-menu" id="gender-menu">
                <div class="gender-dropdown-item" onclick="selectGender('m')">Male</div>
                <div class="gender-dropdown-item" onclick="selectGender('f')">Female</div>
                <div class="gender-dropdown-item" onclick="selectGender('both')">Both</div>
            </div>
        </div>
        <div class="search-row">
            <input type="text" id="search-bar" class="search-box" placeholder="Search Level 2..." oninput="handleSmartSearch()">
            <button class="help-btn-inline" onclick="toggleHelp()">?</button>
        </div>
    </div>
</div>

<div class="map-section">
    <div id="mastery-map" class="grid"></div>
</div>

<script>
    let stats = JSON.parse(localStorage.getItem('pl_mastery_final')) || {};
    let currentLevel = "2"; // Defaulting to Level 2 for your request
    let phrasesData = [], activePool = [], currentTarget = null, currentGender = 'both';
    const THRESHOLD = 3;

    function selectGender(g) {
        currentGender = g;
        const labelMap = { 'm': 'Male', 'f': 'Female', 'both': 'Both' };
        document.getElementById('gender-current').innerText = `Gender: ${labelMap[g]}`;
        document.getElementById('gender-menu').classList.remove('show');
        
        // REFRESH LOGIC
        refreshActivePool();
        updateMap();
        startNewRound();
    }

    function getGenderText(p) {
        // Specifically check for 'both' flag in Level 2 adjectives
        if (p.gender === 'both' && p.variants) {
            if (currentGender === 'm') return p.variants.m;
            if (currentGender === 'f') return p.variants.f;
        }
        return p.pl;
    }

    function refreshActivePool() {
        activePool = phrasesData.filter(p => {
            const isMastered = (stats[p.pl] || 0) >= THRESHOLD;
            // Filter: show if matches selection OR if phrase is gender-neutral (null)
            const matchesGender = (currentGender === 'both') || 
                                  (!p.gender) || 
                                  (p.gender === 'both') || 
                                  (p.gender === currentGender);
            return !isMastered && matchesGender;
        }).slice(0, 12);
    }

    function updateMap() {
        const area = document.getElementById('mastery-map'); area.innerHTML = '';
        // Apply same gender filter to the Map view
        const list = phrasesData.filter(p => {
             const matchesGender = (currentGender === 'both') || (!p.gender) || (p.gender === 'both') || (p.gender === currentGender);
             return matchesGender;
        });

        list.forEach(p => {
            const tile = document.createElement('div'); tile.className = 'tile';
            tile.innerText = getGenderText(p);
            const score = stats[p.pl] || 0;
            if (score >= THRESHOLD) tile.classList.add('mastered-border');
            area.appendChild(tile);
        });
    }

    async function loadLevelData() {
        const r = await fetch(`phrases_${currentLevel}.json`);
        const d = await r.json();
        phrasesData = d.phrases;
        refreshActivePool();
        updateMap();
    }

    function toggleGenderDropdown(e) { e.stopPropagation(); document.getElementById('gender-menu').classList.toggle('show'); }
    function toggleHelp() { const h = document.getElementById('help-overlay'); h.style.display = h.style.display==='flex'?'none':'flex'; }
    
    window.onclick = () => document.getElementById('gender-menu').classList.remove('show');
    window.onload = loadLevelData;
</script>
</body>
</html>
