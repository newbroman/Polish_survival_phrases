<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Master PWA</title>
    <style>
        :root { --pol-red: #dc143c; --wrong-blue: #3498db; --bg: #f0f2f5; --card: #ffffff; --text: #333; --tile-bg: #dee2e6; --accent-blue: #1976d2; }
        @media (prefers-color-scheme: dark) { :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --tile-bg: #404040; --accent-blue: #42a5f5; } }
        
        html, body { height: 100%; margin: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; color: var(--text); }
        
        /* HEADER & UI */
        .header { width: 100%; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .title-banner { background: linear-gradient(to bottom, #ffffff 50%, #dc143c 50%); padding: 8px 0; border-bottom: 1px solid #ccc; position: relative; }
        .title { font-weight: 800; font-size: 1rem; color: #333; text-align: center; margin: 0; }
        .ui-lang-toggle { position: absolute; right: 10px; top: 8px; font-size: 0.65rem; background: #eee; border: 1px solid #ccc; padding: 2px 6px; border-radius: 4px; cursor: pointer; color: #333; }

        .controls-row { width: 90%; max-width: 400px; margin: 0 auto; padding: 6px 0; display: flex; flex-direction: column; gap: 6px; }
        
        .custom-dropdown { position: relative; width: 100%; }
        .dropdown-trigger { 
            width: 100%; background: var(--bg); border: 1px solid #ccc; color: var(--text); 
            padding: 6px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; 
            height: 32px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; box-sizing: border-box;
        }
        .dropdown-trigger::after { content: '‚ñº'; font-size: 7px; color: #888; }
        .dropdown-menu { 
            position: absolute; top: 100%; left: 0; right: 0; background: var(--card); 
            border: 1px solid #ccc; border-radius: 4px; max-height: 300px; overflow-y: auto; 
            z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 12px; font-size: 11px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }

        .progress-container { width: 100%; height: 3px; background: #ddd; }
        #progress-bar { width: 0%; height: 100%; background: var(--pol-red); transition: width 0.5s; }

        .quiz-header { background: var(--card); padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .quiz-top-row { display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center; }
        .icon-btn { background: var(--bg); border: 1px solid #ddd; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .q-text { font-size: 1.1rem; font-weight: 800; text-align: center; flex: 1; max-width: 200px; }
        .feedback { height: 14px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; color: var(--pol-red); }

        .mode-tabs { display: flex; background: var(--card); border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 14px 2px; text-align: center; font-size: 0.6rem; font-weight: bold; cursor: pointer; opacity: 0.5; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--pol-red); color: var(--pol-red); }

        .map-section { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box; }
        .grid { display: grid; gap: 8px; width: 100%; max-width: 400px; }
        .grid-standard { grid-template-columns: repeat(4, 1fr); } 
        .grid-alphabet { grid-template-columns: repeat(5, 1fr); gap: 4px; }
        
        .tile { 
            aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: var(--tile-bg); border-radius: 8px; cursor: pointer; padding: 4px; text-align: center; font-size: 0.65rem;
        }
        .tile .hint { font-size: 0.45rem; opacity: 0.7; }
        .tile .emoji { font-size: 0.75rem; }
        .tile.wrong { background: var(--wrong-blue) !important; color: white !important; }

        .footer { padding: 10px 10px 24px 10px; display: flex; justify-content: center; gap: 6px; border-top: 1px solid #ddd; background: var(--card); }
        .footer-btn { background: var(--bg); border: 1px solid #ccc; color: #666; font-size: 0.7rem; padding: 8px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: bold; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: white; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 id="txt-victory">LEVEL COMPLETE! üèÜ</h1>
    <button onclick="advanceLevel()" style="padding: 15px 30px; background: var(--pol-red); color: white; border: none; border-radius: 8px; font-weight: bold;" id="txt-continue">Next Level</button>
</div>

<div class="header">
    <div class="title-banner">
        <h1 class="title">Polish Master</h1>
        <div class="ui-lang-toggle" onclick="toggleUILang()" id="ui-lang-btn">EN</div>
    </div>
    <div class="controls-row">
        <div class="custom-dropdown">
            <div class="dropdown-trigger" id="lvl-current" onclick="toggleDropdown(event)">Loading Levels...</div>
            <div class="dropdown-menu" id="lvl-menu"></div>
        </div>
        <div style="display:flex; gap:6px; align-items:center;">
            <input type="text" id="search-bar" style="flex:1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;" placeholder="Search..." oninput="handleSmartSearch()">
            <button id="hf-toggle" style="background:#eee; border:1px solid #ccc; padding:6px; border-radius:4px; font-size:0.6rem; font-weight:bold;" onclick="toggleHandsfree()">Handsfree: OFF</button>
        </div>
    </div>
</div>

<div class="progress-container"><div id="progress-bar"></div></div>

<div class="quiz-header">
    <div class="quiz-top-row">
        <button class="icon-btn" onclick="speakTarget()">üîä</button>
        <button class="icon-btn" onclick="toggleSwap()" style="color:var(--accent-blue)">üîÑ</button>
        <div id="q-text" class="q-text">Ready?</div>
    </div>
    <div id="feedback" class="feedback"></div>
</div>

<div class="mode-tabs">
    <div id="tab-learning" class="tab active" onclick="switchMode('learning')">LEARNING</div>
    <div id="tab-mastered" class="tab" onclick="switchMode('mastered')">BANK</div>
    <div id="tab-phrasebook" class="tab" onclick="switchMode('phrasebook')">PHRASEBOOK</div>
</div>

<div class="map-section">
    <div id="mastery-map" class="grid"></div>
</div>

<div class="footer">
    <button class="footer-btn" onclick="downloadProgress()" id="txt-save">Save</button>
    <button class="footer-btn" onclick="resetEverything()" style="color:red" id="txt-reset">Reset</button>
</div>

<script src="phrases.js"></script> 
<script>
    // Alphabet Details for Level 0 integration
    const alphaDetails = {
        'A': {h:'ah', e:'üöó', w:'Auto'}, 'ƒÑ': {h:'own', e:'üåæ', w:'MƒÖka'}, 'B': {h:'b', e:'üëû', w:'But'},
        'C': {h:'ts', e:'üç¨', w:'Cukier'}, 'ƒÜ': {h:'ch!', e:'ü¶ã', w:'ƒÜma'}, 'CH': {h:'h', e:'üçû', w:'Chleb'},
        'CZ': {h:'ch', e:'‚è±Ô∏è', w:'Czas'}, 'D': {h:'d', e:'üè†', w:'Dom'}, 'DZ': {h:'dz', e:'üîî', w:'Dzwon'},
        'D≈π': {h:'j!', e:'üîä', w:'D≈∫wiƒôk'}, 'D≈ª': {h:'j', e:'üçì', w:'D≈ºem'}, 'E': {h:'eh', e:'üì±', w:'Ekran'},
        'ƒò': {h:'en', e:'ü¶¢', w:'Gƒô≈õ'}, 'F': {h:'f', e:'üé®', w:'Farba'}, 'G': {h:'g', e:'üèîÔ∏è', w:'G√≥ra'},
        'H': {h:'h', e:'üçµ', w:'Herbata'}, 'I': {h:'ee', e:'üÜî', w:'Imiƒô'}, 'J': {h:'y', e:'ü•ö', w:'Jajko'},
        'K': {h:'k', e:'üê±', w:'Kot'}, 'L': {h:'l', e:'üí°', w:'Lampa'}, '≈Å': {h:'w', e:'‚õµ', w:'≈Å√≥d≈∫'},
        'M': {h:'m', e:'üë©', w:'Mama'}, 'N': {h:'n', e:'üåô', w:'Noc'}, '≈É': {h:'ny', e:'üêé', w:'Ko≈Ñ'},
        'O': {h:'oh', e:'ü™ü', w:'Okno'}, '√ì': {h:'oo', e:'üå≥', w:'Ogr√≥d'}, 'P': {h:'p', e:'üê∂', w:'Pies'},
        'R': {h:'r', e:'‚úã', w:'Rƒôka'}, 'RZ': {h:'zh', e:'üåä', w:'Rzeka'}, 'S': {h:'s', e:'üßÄ', w:'Ser'},
        '≈ö': {h:'sh!', e:'‚ùÑÔ∏è', w:'≈önieg'}, 'SZ': {h:'sh', e:'üëó', w:'Szafa'}, 'T': {h:'t', e:'üëç', w:'Tak'},
        'U': {h:'oo', e:'üëÇ', w:'Ucho'}, 'W': {h:'v', e:'üíß', w:'Woda'}, 'Y': {h:'i', e:'üë¶', w:'Syn'},
        'Z': {h:'z', e:'ü¶∑', w:'ZƒÖb'}, '≈π': {h:'zh!', e:'üëé', w:'≈πle'}, '≈ª': {h:'zh', e:'üê∏', w:'≈ªaba'}
    };

    const uiTexts = {
        'EN': { learning: 'LEARNING', bank: 'BANK', pb: 'PHRASEBOOK', save: 'Save', reset: 'Reset', victory: 'LEVEL COMPLETE! üèÜ', next: 'Next Level' },
        'PL': { learning: 'NAUKA', bank: 'BANK', pb: 'ROZM√ìWKI', save: 'Zapisz', reset: 'Resetuj', victory: 'POZIOM ZALICZONY! üèÜ', next: 'Nastƒôpny Poziom' }
    };

    // If phrases.js isn't loaded, create empty array to prevent crashes
    if (typeof phrases === 'undefined') { var phrases = []; }

    let stats = JSON.parse(localStorage.getItem('pl_mastery_final')) || {};
    let currentLevel = parseInt(localStorage.getItem('pl_current_level_idx')) || 0;
    let uiLang = localStorage.getItem('pl_ui_lang') || 'EN';
    let isSwapped = (localStorage.getItem('pl_swap') === 'true');
    let isHandsfree = false, hfTimeout = null;
    let activePhrases = [], currentTarget = null;

    function init() {
        applyUILang();
        buildLevelMenu();
        loadLevel();
    }

    function buildLevelMenu() {
        const menu = document.getElementById('lvl-menu'); menu.innerHTML = '';
        // Find unique level numbers in the data
        const levels = [...new Set(phrases.map(p => p.level))].sort((a,b) => a-b);
        
        levels.forEach(lvl => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            // Find first phrase category for that level as a label
            const category = phrases.find(p => p.level === lvl)?.category || 'Phrases';
            item.innerHTML = `<span>Lvl ${lvl}: ${category}</span>`;
            item.onclick = () => { currentLevel = lvl; loadLevel(); toggleDropdown(); };
            menu.appendChild(item);
            if (lvl === currentLevel) document.getElementById('lvl-current').innerText = `Lvl ${lvl}: ${category}`;
        });
    }

    function loadLevel() {
        activePhrases = phrases.filter(p => p.level === currentLevel && (stats[p.pl] || 0) < 3).slice(0, 15);
        localStorage.setItem('pl_current_level_idx', currentLevel);
        updateUI();
    }

    function updateUI() {
        const area = document.getElementById('mastery-map'); area.innerHTML = '';
        area.className = (currentLevel === 0) ? "grid grid-alphabet" : "grid grid-standard";
        
        if (activePhrases.length === 0) {
            area.innerHTML = `<div style="padding:40px; text-align:center;"><h2>Well Done! üèÖ</h2></div>`;
            return;
        }

        activePhrases.forEach(p => {
            const tile = document.createElement('div'); tile.className = 'tile';
            if (currentLevel === 0) {
                const det = alphaDetails[p.pl] || {};
                tile.innerHTML = `<b>${isSwapped ? p.en : p.pl}</b><span class="hint">${det.h||''}</span><span class="emoji">${det.e||''}</span>`;
            } else {
                tile.innerHTML = `<span>${isSwapped ? p.en : p.pl}</span>`;
            }
            tile.onclick = () => checkAnswer(p, tile);
            area.appendChild(tile);
        });
        startNewRound();
        updateProgress();
    }

    function startNewRound() {
        if (!activePhrases.length) return;
        currentTarget = activePhrases[Math.floor(Math.random() * activePhrases.length)];
        
        let q;
        if (currentLevel === 0) {
            q = isSwapped ? currentTarget.pl : (alphaDetails[currentTarget.pl]?.w || currentTarget.en);
        } else {
            q = isSwapped ? currentTarget.pl : currentTarget.en;
        }
        
        document.getElementById('q-text').innerText = q;
        if (!isSwapped) speak(currentTarget.pl);

        if (isHandsfree) {
            clearTimeout(hfTimeout);
            hfTimeout = setTimeout(() => checkAnswer(currentTarget, null), 4000);
        }
    }

    function checkAnswer(p, el) {
        if (p.pl === currentTarget.pl) {
            if (isSwapped) speak(p.pl);
            stats[p.pl] = (stats[p.pl] || 0) + 1;
            document.getElementById('feedback').innerText = "Dobrze!";
            save();
            setTimeout(() => {
                if (stats[p.pl] >= 3) activePhrases = activePhrases.filter(x => x.pl !== p.pl);
                updateUI();
            }, 600);
        } else if (el) {
            el.classList.add('wrong');
            setTimeout(() => el.classList.remove('wrong'), 500);
        }
    }

    function speak(t) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang='pl-PL'; window.speechSynthesis.speak(m); }
    function speakTarget() { if(currentTarget) speak(currentTarget.pl); }
    function toggleSwap() { isSwapped = !isSwapped; localStorage.setItem('pl_swap', isSwapped); updateUI(); }
    function toggleUILang() { uiLang = (uiLang === 'EN' ? 'PL' : 'EN'); localStorage.setItem('pl_ui_lang', uiLang); applyUILang(); }
    function applyUILang() {
        const t = uiTexts[uiLang];
        document.getElementById('ui-lang-btn').innerText = uiLang;
        document.getElementById('tab-learning').innerText = t.learning;
        document.getElementById('tab-mastered').innerText = t.bank;
        document.getElementById('tab-phrasebook').innerText = t.pb;
        document.getElementById('txt-save').innerText = t.save;
        document.getElementById('txt-reset').innerText = t.reset;
        document.getElementById('txt-victory').innerText = t.victory;
        document.getElementById('txt-continue').innerText = t.next;
    }
    function toggleHandsfree() { 
        isHandsfree = !isHandsfree; 
        document.getElementById('hf-toggle').innerText = `Handsfree: ${isHandsfree ? 'ON' : 'OFF'}`;
        if (isHandsfree) startNewRound(); else clearTimeout(hfTimeout);
    }
    function toggleDropdown(e) { if(e) e.stopPropagation(); document.getElementById('lvl-menu').classList.toggle('show'); }
    function save() { localStorage.setItem('pl_mastery_final', JSON.stringify(stats)); }
    function updateProgress() {
        const total = phrases.filter(p => p.level === currentLevel).length;
        const mastered = phrases.filter(p => p.level === currentLevel && (stats[p.pl]||0) >= 3).length;
        document.getElementById('progress-bar').style.width = (mastered/total)*100 + "%";
    }
    function resetEverything() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
    window.onload = init;
</script>
</body>
</html>
